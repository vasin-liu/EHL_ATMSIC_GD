Map=Class.create();Map.prototype={mapTypes:new Object(),currentMapType:null,initialize:function(container){this.container=container;this.container.innerHTML="";this.container.style.backgroundColor='white';this.mapId=Util.createUniqueID();this.containerWidth=Util.getValueOfNoPX(this.container.style.width);this.containerHeight=Util.getValueOfNoPX(this.container.style.height);this.model=new MapModel(this.mapId);this.mapControl=new MapControl("map_"+this.mapId,this.container);this.model.controls[this.mapControl.id]=this.mapControl;var scale=new ScaleControl(container);this.model.controls[scale.id]=scale;this.searchWindow=null;this.bindMouseWheel=this.map_mousewheel.bindAsEventListener(this);},getMapWidth:function(){return this.containerWidth;},getMapHeight:function(){return this.containerHeight;},getMapDiv:function(){return this.mapControl.getMapDiv();},getVMLDiv:function(){return this.mapControl.getVMLDiv();},getCurrentZoom:function()
{return this.model.getZoom();},getMapModel:function()
{return this.model;},getContainer:function(){return this.container;},setDefaultCenter:function(centerPoint,level){this.model.defaultCenterPoint=centerPoint;this.model.defaultLevel=level;this.model.setViewCenterCoord(centerPoint.getCoord());this.model.setZoom(new Zoom(level));this.mapControl.paint(this.model,true);this.level=level;Event.observe(this.mapControl.mapDiv,"mousemove",this.map_mousemove.bindAsEventListener(this));},bindMouseWheelEvent:function(flag){if(flag){Event.observe(this.mapControl.mapDiv,"mousewheel",this.bindMouseWheel);}else{Event.stopObserving(this.mapControl.mapDiv,"mousewheel",this.bindMouseWheel);}},setSpecialCenter:function(centerPoint,level){this.model.setZoom(new Zoom(level));this.mapControl.paint(this.model,true);this.level=level;this.moveToCenter(centerPoint.getCoord());},moveToCenter:function(nowCenterCoord,level){var orgCenterCoord=this.model.getViewCenterCoord();var curZoom=this.model.getZoom();var newCenterCoord=new Coordinate(nowCenterCoord.x,nowCenterCoord.y);if(!newCenterCoord.isSame(orgCenterCoord)){this.model.setViewCenterCoord(newCenterCoord);}
if(level){var orgLevel=curZoom.getLevel();level=Number(level);if(level!=orgLevel){if(level>MaxZoomLevel)
{level=MaxZoomLevel;}
this.model.setZoom(new Zoom(level));if(typeof(navControl)!="undefined")
{navControl.paint(this.model);}}}
this.mapControl.paint(this.model,true);if(typeof(navControl)!="undefined")
{this.model.controls[this.model.ovId].paint(this.model);}},getCenterCoord:function(points){var minX=180e16,maxX=0,minY=90e16,maxY=0;for(var i=0;i<points.length;i++){var coord=points[i].split(",");var point=new Point(coord[0],coord[1]);if(point.getCoord().x<minX){minX=point.getCoord().x;}
if(point.getCoord().x>maxX){maxX=point.getCoord().x;}
if(point.getCoord().y<minY){minY=point.getCoord().y;}
if(point.getCoord().y>maxY){maxY=point.getCoord().y;}}
var bound=new Bound(minX,maxX,minY,maxY);return bound.getCenterCoord();},map_mousewheel:function(e){var level=this.model.getZoom().getLevel();if(window.event.wheelDelta==120&&level<MaxZoomLevel){level+=1;this.model.setZoom(new Zoom(level));this.mapControl.paint(this.model,true);}
else{if(window.event.wheelDelta==-120&&level>1){level-=1;this.model.setZoom(new Zoom(level));this.mapControl.paint(this.model,true);}}
$('sliderbar_'+this.model.getId()).parentNode.style.top=((MaxZoomLevel-level)*12+6)+"px";this.model.controls[this.model.ovId].paint(this.model);},map_mousemove:function(e){var nowMouseDownPixel=Util.getMouseRelativePixel(e,this.mapControl.getMapDiv());var coord=Util.getCoordinateByPixel(nowMouseDownPixel,map.getCurrentZoom());coord.x=coord.x/1e16;coord.y=coord.y/1e16;window.status="当前位置:(经度:"+coord.x+",纬度:"+coord.y+")";},addMapType:function(type,isCurrent){if(isCurrent){this.model.setCurrentMapType(type);}
this.model.mapTypeIds.push(type.typeId);this.model.mapTypes[type.typeId]=type;type.paint(this.model,$('map'));},addOverLayer:function(layer){},addControl:function(control,bToolbar){control.paint(this.model);this.model.controls[control.id]=control;if(bToolbar==true){control.setMapModel(this.model);control.registerEventToMap(this.mapControl.mapDiv);}},addToolBar:function(imgPath){var toolbar=new ToolBarControl($('map'));toolbar.addDefaultToolBar(imgPath);this.addControl(toolbar,true);return toolbar;},addEagle:function(){ovmap=new OvMap($('map'));this.addControl(ovmap);return ovmap;},addNavigation:function(){navControl=new NavControl($('map'));this.addControl(navControl);return navControl;},getCurrLevel:function(){return this.model.getZoom().getLevel();},repaint:function(){var mapContainer=$('map');mapContainer.style.width=mapContainer.style.pixelWidth;mapContainer.style.height=mapContainer.style.pixelHeight;this.container=mapContainer;this.container.innerHTML="";this.container.style.backgroundColor='white';this.mapId=Util.createUniqueID();this.containerWidth=Util.getValueOfNoPX(this.container.style.width);this.containerHeight=Util.getValueOfNoPX(this.container.style.height);this.model=new MapModel(this.mapId);this.mapControl=new MapControl("map_"+this.mapId,this.container);this.model.controls[this.mapControl.id]=this.mapControl;var scale=new ScaleControl(this.container);this.model.controls[scale.id]=scale;}};
MapModel=Class.create();MapModel.prototype={OvContainer:null,controls:new Object(),ovId:null,defaultCenterPoint:null,defaultLevel:null,overlays:null,traceIndex:0,traces:new Object(),curIndex:-1,mapTypeIds:new Array(),initialize:function(id){this.modelId=id;this.mapTypes=new Object();},getZoom:function(){return this.zoom;},setZoom:function(zoom){this.zoom=zoom;},setViewCenterCoord:function(centerCoord){this.viewCenterCoord=centerCoord;},getViewCenterCoord:function(){return this.viewCenterCoord;},getViewBound:function(){return this.viewBound;},setViewBound:function(bound){this.viewBound=bound;},setCurrentMapType:function(type){this.currentMapType=type;},getCurrentMapType:function(){return this.currentMapType;},getId:function(){return this.modelId;},getOvContainer:function(){return this.OvContainer;},getOvMapDiv:function(){return this.OvContainer.childNodes[0];},setOvContainer:function(ovContainer,id){this.OvContainer=ovContainer;this.ovId=id;},getOvModel:function(){var newModel=new MapModel(Util.createUniqueID());newModel.setViewCenterCoord(this.getViewCenterCoord());ovLevel=1;var zoom=new Zoom(ovLevel);newModel.setZoom(zoom);newModel.setCurrentMapType(this.getCurrentMapType());newModel.setViewBound(zoom.getViewBound(this.OvContainer));return newModel;},reset:function(mapDiv,elm){this.setViewCenterCoord(this.defaultCenterPoint.getCoord());this.setZoom(new Zoom(this.defaultLevel));this.controls[mapDiv.id].paint(this,true);this.controls[this.ovId].paint(this);elm.style.top=((MaxZoomLevel-this.defaultLevel)*12+6)+"px";},clearOverLayers:function(mapDiv){if(this.overlays){for(var i=0;i<this.overlays.length;i++){this.overlays[i].remove();}
this.overlays.clear();}}};
MapType=function(){};MapType.prototype={initialize:function(dirSrc,enImg,disImg,firstRows,firstCols){this.enableImg=ImageBaseDir+enImg;this.disableImg=ImageBaseDir+disImg;this.typeId='mapType_'+Util.createUniqueID();this.dirSrc=dirSrc;this.firstRows=firstRows;this.firstCols=firstCols;},getSrc:function(level,row,column){var dirName=this.dirSrc+level+'/'+level+'_'+Math.floor(row/128)+'/'+row+'/'+row+'_'+Math.floor(column/128);var fileName=level+'_'+row+'_'+column+'.jpg';var src=dirName+'/'+fileName;return src;},paint:function(model,container){this.model=model;this.container=container;var ids=new Array();},mapTypeSwitch:function(e){var id=this.curId.substring(4,this.curId.length);mapType=this.model.mapTypes[id];this.model.setCurrentMapType(mapType);this.ClearOrgMapType(this.container.childNodes[0]);this.model.controls[this.container.childNodes[0].id].paint(this.model,true);this.model.controls[this.model.ovId].paint(this.model);mapType.paint(this.model,this.container);},ClearOrgMapType:function(container){var mapDiv=container;var tileNodes=mapDiv.childNodes;if(tileNodes){for(var i=0;i<tileNodes.length;i++){mapDiv.removeChild(tileNodes[i]);i--;}}}};SZMapType=Class.create();SZMapType.prototype=Object.extend(new MapType(),{getSrc:function(level,row,column){var dirName=this.dirSrc+level+'/'+level+'_'+Math.floor(row/128)+'/'+row+'/'+row+'_'+Math.floor(column/128);var fileName=level+'_'+row+'_'+column+'.jpg';var src=dirName+'/'+fileName;return src;}});
Tile=Class.create();Tile.prototype={initialize:function(row,column,level,model){this.row=row;this.column=column;this.level=level;this.model=model;},getRow:function(){return this.row;},getColumn:function(){return this.column;},getLevel:function(){return this.level;},getMapModel:function(){return this.model;},getSrc:function(){return this.model.getCurrentMapType().getSrc(this.level,this.row,this.column);}}
Zoom=Class.create();Zoom.prototype={initialize:function(level){this.level=level;this.tileCols=FirstZoomTileCols*Math.pow(2,(this.level-1));this.tileRows=FirstZoomTileRows*Math.pow(2,(this.level-1));this.tileNum=this.tileCols*this.tileRows;this.scale=Width/(this.tileCols*TileSize*2.54/100/96);this.realMapBound=FullExtent;},getViewBound:function(container){var width=Util.getValueOfNoPX(container.style.width);var height=Util.getValueOfNoPX(container.style.height);this.viewBound=this.realMapBound.getCenterCoord().getBound(width*this.realMapBound.getWidth()/(this.tileCols*TileSize),height*this.realMapBound.getHeight()/(this.tileRows*TileSize));return this.viewBound;},getLevel:function(){return this.level;},getTileCols:function(){return this.tileCols;},getTileRows:function(){return this.tileRows;},getScale:function(){return this.scale;},getTiles:function(model,container){var coord=model.getViewCenterCoord();var viewBound=this.getViewBound(container);if(viewBound.getCenterCoord()!=coord){viewBound=viewBound.clone(coord);}
if(!this.realMapBound.isCover(viewBound)){return null;}
else{var tiles=new Array();var rowFrom=Math.floor((this.realMapBound.getMaxY()-viewBound.getMaxY())/(this.realMapBound.getHeight()/this.tileRows));rowFrom=rowFrom<0?0:rowFrom;var rowTo=Math.floor((viewBound.getMinY()-this.realMapBound.getMinY())/(this.realMapBound.getHeight()/this.tileRows));rowTo=rowTo<0?this.tileRows:(this.tileRows-rowTo);var colFrom=Math.floor((viewBound.getMinX()-this.realMapBound.getMinX())/(this.realMapBound.getWidth()/this.tileCols));colFrom=colFrom<0?0:colFrom;var colTo=Math.floor((this.realMapBound.getMaxX()-viewBound.getMaxX())/(this.realMapBound.getWidth()/this.tileCols));colTo=colTo<0?this.tileCols:(this.tileCols-colTo);var delta=1;rowFrom=rowFrom-delta<0?0:rowFrom-delta;rowTo=rowTo+delta>this.tileRows?this.tileRows:rowTo+delta;colFrom=colFrom-delta<0?0:colFrom-delta;colTo=colTo+delta>this.tileCols?this.tileCols:colTo+delta;for(var i=rowFrom;i<rowTo;i++){for(var j=colFrom;j<colTo;j++){var tile=new Tile(i,j,this.level,model);tiles.push(tile);}}
return tiles;}}}
Abstract.OverLayer=function(){};Abstract.OverLayer.prototype={initialize:function(mapDiv){},insert:function(){if(this.model==null){return;}
if(this.model.overlays==null){this.model.overlays=new Array();}
this.model.overlays.push(this);this.vmlDiv.appendChild(this.vPolyline);},remove:function(){if(this.model==null){return;}
if(this.model.overlays){this.model.overlays.without(this);this.vmlDiv.removeChild(this.vPolyline);}}};
Bound=Class.create();Bound.prototype={initialize:function(minX,maxX,minY,maxY){this.minX=minX;this.maxX=maxX;this.minY=minY;this.maxY=maxY;this.centerCoord=new Coordinate((this.minX+this.maxX)/2,(this.minY+this.maxY)/2);},getCenterCoord:function(){return this.centerCoord;},clone:function(coord){if(coord==null||coord.isSame(this.centerCoord)){return this;}
else{var minX=this.minX+coord.x-this.centerCoord.x;var maxX=this.maxX+coord.x-this.centerCoord.x;var minY=this.minY+coord.y-this.centerCoord.y;var maxY=this.maxY+coord.y-this.centerCoord.y;return new Bound(minX,maxX,minY,maxY);}},isCover:function(bound){if(this.getMinX()>bound.getMaxX()||this.getMaxX()<bound.getMinX()||this.getMinY()>bound.getMaxY()||this.getMaxY()<bound.getMinY()){return false;}
return true;},isWithin:function(coord){if(coord.x<this.maxX&&coord.x>this.minX&&coord.y<this.maxY&&coord.y>this.minY){return true;}
return false;},getMinX:function(){return this.minX;},getMaxX:function(){return this.maxX;},getMinY:function(){return this.minY;},getMaxY:function(){return this.maxY;},getHeight:function(){return Math.abs(this.maxY-this.minY);},getWidth:function(){return Math.abs(this.maxX-this.minX);},getPixelHeight:function(zoom){var topleft=Util.getScreenPixel(new Coordinate(this.minX,this.maxY),zoom).y;var bottomright=Util.getScreenPixel(new Coordinate(this.maxX,this.minY),zoom).y;return Math.floor(Math.abs(topleft-bottomright));},getPixelWidth:function(zoom){var topleft=Util.getScreenPixel(new Coordinate(this.minX,this.maxY),zoom).x;var bottomright=Util.getScreenPixel(new Coordinate(this.maxX,this.minY),zoom).x;return Math.floor(Math.abs(bottomright-topleft));}}
Coordinate=Class.create();Coordinate.prototype={initialize:function(x,y){this.x=x;this.y=y;},isSame:function(coord){if(this.x==coord.x&&this.y==coord.y)
return true;return false;},getBound:function(width,height){return new Bound(this.x-width/2,this.x+width/2,this.y-height/2,this.y+height/2);},getPoint:function(){return new Point(this.x/1e16,this.y/1e16);},toString:function(){return'X:'+this.x+',Y:'+this.y;}}
Point=Class.create();Point.prototype={initialize:function(x,y){this.x=x;this.y=y;this.coord=new Coordinate(x*1e16,y*1e16);},getCoord:function(){return this.coord;},setCoord:function(coord){this.coord=coord;},calcuDistance:function(point){return Util.distanceByLnglat(this.x,this.y,point.x,point.y);},toString:function(){return'X:'+this.x+',Y:'+this.y;}}
Polyline=Class.create();Polyline.prototype=Object.extend(new Abstract.OverLayer(),{initialize:function(id,points,color,size,offset,bStroke,dashStyle,startArrow,endArrow,bMeasure){this.id=id;this.points=points;this.color=color;this.size=size;this.bound=this.buildExtent();this.bStroke=bStroke;this.dashStyle=dashStyle;this.startArrow=startArrow;this.endArrow=endArrow;this.bMeasure=bMeasure;this.offset=offset;},buildExtent:function(){var minX=180e16,maxX=0,minY=90e16,maxY=0;for(var i=0;i<this.points.length;i++){if(this.points[i].getCoord().x<minX){minX=this.points[i].getCoord().x;}
if(this.points[i].getCoord().x>maxX){maxX=this.points[i].getCoord().x;}
if(this.points[i].getCoord().y<minY){minY=this.points[i].getCoord().y;}
if(this.points[i].getCoord().y>maxY){maxY=this.points[i].getCoord().y;}}
return new Bound(minX,maxX,minY,maxY);},getExtent:function(){return this.bound;},setExtent:function(extent){this.bound=extent;},getCenterCoord:function(){return this.getExtent().getCenterCoord();},getLength:function(){if(this.points.length<=1){return 0;}
var len=0;for(var i=0;i<this.points.length-1;i++){len+=this.points[i].calcuDistance(this.points[i+1]);}
return len;},createPolyline:function(pointsStr){var posStyle="absolute";var vPolyline=document.createElement("v:polyline");vPolyline.id=this.id;vPolyline.filled=false;vPolyline.style.position=posStyle;vPolyline.strokecolor=this.color;vPolyline.strokeweight=this.size;vPolyline.points=pointsStr;if(this.bStroke){var vStroke=document.createElement("v:stroke");vStroke.dashstyle=this.dashStyle;vStroke.startarrow=this.startArrow;vStroke.endarrow=this.endArrow;vPolyline.appendChild(vStroke);}
return vPolyline;},setToMap:function(mapDiv,model,overLayerDiv){this.mapDiv=mapDiv;this.model=model;this.vmlDiv=map.getVMLDiv();var curZoom=model.getZoom();var pixel=Util.getScreenPixel(new Coordinate(this.getExtent().getMinX(),this.getExtent().getMaxY()),curZoom);var lines=new Array();for(var i=0;i<this.points.length;i++){var sPoint=Util.getScreenPixel(new Coordinate(this.points[i].getCoord().x,this.points[i].getCoord().y),curZoom);if(this.offset){lines.push(Math.floor(sPoint.x+this.offset.x)+','+Math.floor(sPoint.y+this.offset.y)+',');}else{lines.push(Math.floor(sPoint.x)+','+Math.floor(sPoint.y)+',');}}
this.vPolyline=this.createPolyline(lines.join(""));if(!this.bMeasure){this.mapDiv.appendChild(this.vPolyline);}
else{this.insert();}
return this.vPolyline;}});PolylineByPixel=Class.create();PolylineByPixel.prototype=Object.extend(new Abstract.OverLayer(),{initialize:function(id,points,color,size,bStroke,dashStyle,startArrow,endArrow,bMeasure){this.id=id;this.points=points;this.color=color;this.size=size;this.bStroke=bStroke;this.dashStyle=dashStyle;this.startArrow=startArrow;this.endArrow=endArrow;this.bMeasure=bMeasure;},createPolyline:function(pointsStr){var posStyle="absolute";var vPolyline=document.createElement("v:polyline");vPolyline.id=this.id;vPolyline.filled=false;vPolyline.style.position=posStyle;vPolyline.strokecolor=this.color;vPolyline.strokeweight=this.size;vPolyline.points=pointsStr;if(this.bStroke){var vStroke=document.createElement("v:stroke");vStroke.dashstyle=this.dashStyle;vStroke.startarrow=this.startArrow;vStroke.endarrow=this.endArrow;vPolyline.appendChild(vStroke);}
return vPolyline;},setToMap:function(mapDiv){this.mapDiv=mapDiv;var lines=new Array();this.vPolyline=this.createPolyline(this.points);if(!this.bMeasure){this.mapDiv.appendChild(this.vPolyline);}
else{this.insert();}
return this.vPolyline;}});
Rectangle=Class.create();Rectangle.prototype={initialize:function(minX,maxX,minY,maxY){this.minX=minX;this.maxX=maxX;this.minY=minY;this.maxY=maxY;this.bound=new Bound(minX*1e16,maxX*1e16,minY*1e16,maxY*1e16);},getPixelWidth:function(zoom){var topleft=Util.getScreenPixel((new Point(this.minX,this.maxY)).getCoord(),zoom).x;var bottomright=Util.getScreenPixel((new Point(this.maxX,this.minY)).getCoord(),zoom).x;return Math.floor(Math.abs(bottomright-topleft));},getPixelHeight:function(zoom){var topleft=Util.getScreenPixel((new Point(this.minX,this.maxY)).getCoord(),zoom).y;var bottomright=Util.getScreenPixel((new Point(this.maxX,this.minY)).getCoord(),zoom).y;return Math.floor(Math.abs(topleft-bottomright));},getBound:function(){return this.bound;},getCenter:function(){return this.bound.getCenterCoord();}}
Oval=Class.create();Oval.prototype=Object.extend(new Abstract.OverLayer(),{initialize:function(id,points,color,size,fillColor,isCircle){this.id=id;this.points=points;this.color=color;this.size=size;this.fillColor=fillColor;this.isCircle=isCircle;this.bound=this.buildExtent();},buildExtent:function(){var minX=180e16,maxX=0,minY=90e16,maxY=0;for(var i=0;i<this.points.length;i++){if(this.points[i].getCoord().x<minX){minX=this.points[i].getCoord().x;}
if(this.points[i].getCoord().x>maxX){maxX=this.points[i].getCoord().x;}
if(this.points[i].getCoord().y<minY){minY=this.points[i].getCoord().y;}
if(this.points[i].getCoord().y>maxY){maxY=this.points[i].getCoord().y;}}
return new Bound(minX,maxX,minY,maxY);},getExtent:function(){return this.bound;},setExtent:function(extent){this.bound=extent;},getCenterCoord:function(){return this.getExtent().getCenterCoord();},createOval:function(left,top,width,height){var posStyle="absolute";var vOval=document.createElement("v:oval");vOval.id=this.id;vOval.filled=false;vOval.style.position=posStyle;vOval.strokecolor=this.color;vOval.strokeweight=this.size;vOval.style.left=left;vOval.style.top=top;vOval.style.width=width;vOval.style.height=height;if(this.fillColor){vOval.filled=true;vOval.fillcolor=this.fillColor;}
return vOval;},setToMap:function(mapDiv,model){this.mapDiv=mapDiv;this.model=model;var curZoom=model.getZoom();var leftTop=Util.getScreenPixel(new Coordinate(this.points[0].getCoord().x,this.points[0].getCoord().y),curZoom);var rightBottom=Util.getScreenPixel(new Coordinate(this.points[1].getCoord().x,this.points[1].getCoord().y),curZoom);var width=rightBottom.x-leftTop.x;var height=rightBottom.y-leftTop.y;if(this.isCircle){width=Math.max(width,height);height=width;}
this.vOval=this.createOval(leftTop.x,leftTop.y,width,height);this.mapDiv.appendChild(this.vOval);return this.vOval;}});OvalByPixel=Class.create();OvalByPixel.prototype=Object.extend(new Abstract.OverLayer(),{initialize:function(id,points,color,size,fillColor){this.id=id;this.points=points;this.color=color;this.size=size;this.fillColor=fillColor;},createOval:function(left,top,width,height){var posStyle="absolute";var vOval=document.createElement("v:oval");vOval.id=this.id;vOval.filled=false;vOval.style.position=posStyle;vOval.strokecolor=this.color;vOval.strokeweight=this.size;vOval.style.left=left;vOval.style.top=top;vOval.style.width=width;vOval.style.height=height;if(this.fillColor){vOval.filled=true;vOval.fillcolor=this.fillColor;}
return vOval;},setToMap:function(mapDiv){this.mapDiv=mapDiv;var arrPoints=this.points.split(";");var leftTop=arrPoints[0].split(",");var rightBottom=arrPoints[1].split(",");var width=parseInt(rightBottom[0])-parseInt(leftTop[0]);var height=parseInt(rightBottom[1])-parseInt(leftTop[1]);this.vOval=this.createOval(leftTop[0],leftTop[1],width,height);this.mapDiv.appendChild(this.vOval);return this.vOval;}});Circle=Class.create();Circle.prototype=Object.extend(new Abstract.OverLayer(),{initialize:function(id,point,radius,color,size,fillColor){this.id=id;this.point=point;this.radius=radius;this.color=color;this.size=size;this.fillColor=fillColor;},createCircle:function(left,top,width,height){var posStyle="absolute";var vCircle=document.createElement("v:oval");vCircle.id=this.id;vCircle.filled=false;vCircle.style.position=posStyle;vCircle.strokecolor=this.color;vCircle.strokeweight=this.size;vCircle.style.left=left;vCircle.style.top=top;vCircle.style.width=width;vCircle.style.height=height;if(this.fillColor){vCircle.filled=true;vCircle.fillcolor=this.fillColor;}
return vCircle;},setToMap:function(mapDiv,model){this.mapDiv=mapDiv;this.model=model;var curZoom=model.getZoom();var coord=this.point.split(",");var center=Util.getScreenPixel(new Coordinate(coord[0],coord[1]),curZoom);var width=this.radius*2;var height=this.radius*2;this.vCircle=this.createCircle(center.x-this.radius,center.y-this.radius,width,height);this.mapDiv.appendChild(this.vCircle);return this.vCircle;}});
Marker=Class.create();Marker.prototype=Object.extend(new Abstract.OverLayer(),{initialize:function(){this.id=Util.createUniqueID("Over_Marker_");},getCoord:function(){return this.coord;},setCoord:function(point){this.coord=point.getCoord();},getIcon:function(){return this.icon;},setIcon:function(icon){this.icon=icon;},getInfo:function(){return this.info;},setInfo:function(info){this.info=info;},getShadowIcon:function(){return this.shadowIcon;},setShadowIcon:function(sIcon){this.shadowIcon=sIcon;},setToMap:function(mapDiv,model,overLayDiv){this.mapDiv=mapDiv;this.model=model;this.sPoint=Util.getScreenPixel(this.coord,model.getZoom());var deltaX=this.sPoint.x-this.icon.width/2;var deltaY=this.sPoint.y-this.icon.height;var markerDiv=$(this.id);var markerDiv=Util.createDiv(this.id,deltaX,deltaY,this.icon.width,this.icon.height,null,'absolute');markerDiv.style.zIndex=10;markerDiv.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src="+this.icon.src+", sizingmethod=scale);";if(overLayDiv){this.div=overLayDiv;overLayDiv.style.left=deltaX+'px';overLayDiv.style.top=deltaY+'px';}
else{this.model.clearOverLayers();this.div=markerDiv;this.insert();this.div.style.cursor="hand";}
this.showInfoWindow();Event.observe(markerDiv,"click",this.reLoadInfo.bindAsEventListener(this));},reLoadInfo:function(e){if(this.info&&this.infoDiv){this.infoDiv.style.display="";}},showInfoWindow:function(){var newDeltaX=this.sPoint.x+this.icon.width-8;var newDeltaY=this.sPoint.y-this.icon.height-60;var mapDiv=$("map_"+this.model.getId());this.infoDiv=$("Over_Marker_Info");this.infoDiv.style.left=newDeltaX;this.infoDiv.style.top=newDeltaY;this.infoDiv.style.cursor="default";this.infoDiv.style.display="";$('Info').innerHTML=this.info;mapDiv.appendChild(this.infoDiv);}});Icon=Class.create();Icon.prototype={initialize:function(w,h,src){this.width=w;this.height=h;this.src=src;}};function hideInfoWindown(e,windowId){var infoWindow=$(windowId);infoWindow.style.display="none";Event.stop(e);}
Abstract.Control=function(){};Abstract.Control.prototype={initialize:function(){},paint:function(){},loadTiles:function(model,container,mapDiv,isTracing,isMap){var curZoom=model.getZoom();var viewBound=curZoom.getViewBound(mapDiv).clone(model.getViewCenterCoord());var tiles=curZoom.getTiles(model,container);var oldTiles=new Array();var tileDivs=mapDiv.childNodes;if(mapDiv.id.indexOf('Ov_')==-1){var scale=curZoom.getScale()*1.5/100;if(scale<1000){scale=parseInt(scale)+" ";}
else{scale=parseInt(scale/1000*100)/100+" ";}
$('scaleInfo').innerHTML=scale;}
if(isTracing){model.traces[model.traceIndex]={coord:model.getViewCenterCoord(),level:curZoom.getLevel()};model.curIndex=model.traceIndex;model.traceIndex+=1;}
var n=0;if(tileDivs){for(var i=0;i<tileDivs.length;i++){oldTiles.push(tileDivs[i]);}}
if(tiles){for(var i=0;i<tiles.length;i++){var tileId="map_"+model.getId()+"_zoom_"+model.getZoom().getLevel()+"_tile_"+tiles[i].getRow()+"_"+tiles[i].getColumn();var isExist=false;for(var j=0;j<oldTiles.length;j++){if(oldTiles[j]!=null&&oldTiles[j].getAttribute("id")==tileId){isExist=true;oldTiles[j]=null;break;}}
if(!isExist){var deltaX=tiles[i].getColumn()*TileSize;var deltaY=tiles[i].getRow()*TileSize;var tile=document.createElement("div");tile.id=tileId;tile.style.position="absolute";tile.style.left=deltaX+"px";tile.style.top=deltaY+"px";tile.onmousedown=null;mapDiv.appendChild(tile);var tileImage=document.createElement("img");tileImage.src=tiles[i].getSrc();tileImage.galleryImg='no';tileImage.onmousedown=null;tileImage.width=TileSize;tileImage.height=TileSize;tile.appendChild(tileImage);n++;}}}
for(var i=0;i<oldTiles.length;i++){if(oldTiles[i]!=null&&oldTiles[i].getAttribute("id").indexOf("Over_")>-1){continue;}
if(oldTiles[i]!=null){mapDiv.removeChild(oldTiles[i]);}}
oldTiles=null;tiles=null;tileDivs=null;if(isMap){fireTileChangeListener();}}};
OvMap=Class.create();OvMap.prototype=Object.extend(new Abstract.Control(),{initialize:function(container){this.container=container;this.deltaXAixs=0;this.deltaYAixs=0;this.extX=22;this.drawOvContainer(container);},paint:function(model){this.model=model;this.model.setOvContainer(this.ovMapDiv,this.id);this.ovModel=this.model.getOvModel();var curZoom=this.ovModel.getZoom();var viewBound=curZoom.getViewBound(this.ovMapDiv).clone(model.getViewCenterCoord());var mapBound=curZoom.realMapBound;var deltaX=(mapBound.getMinX()-viewBound.getMinX())*(curZoom.getTileCols()*TileSize/mapBound.getWidth());var deltaY=(viewBound.getMaxY()-mapBound.getMaxY())*(curZoom.getTileRows()*TileSize/mapBound.getHeight());this.ovDiv.style.left=deltaX+"px";this.ovDiv.style.top=deltaY+"px";this.ovDiv.style.width=(curZoom.getTileCols()*TileSize)+"px";this.ovDiv.style.height=(curZoom.getTileRows()*TileSize)+"px";this.loadTiles(this.ovModel,this.ovMapDiv,this.ovDiv,false,false);this.container.appendChild(this.ovMapDiv);},drawOvContainer:function(container){var containerWidth=Util.getValueOfNoPX(container.style.width);var containerHeight=Util.getValueOfNoPX(container.style.height);var width=Number(getMapParameter("gisAngleWidth"));var height=Number(getMapParameter("gisAngleHeight"));var x=width/2-width/4/2;var y=height/2-height/4/2;var left=containerWidth-width;var top=containerHeight-height;if(Util.isIE()){left=left+1;top=top+1;}
else{left=left-5;top=top-5;}
this.id=Util.createUniqueID('Ov_');this.ovMapDiv=Util.createDiv(this.id,left,top,width,height,null,'absolute','2px ridge blue');this.ovMapDiv.style.overflow='hidden';this.ovMapDiv.style.backgroundColor='white';this.ovDiv=Util.createDiv(Util.createUniqueID('Ov_Map_'));this.ovDiv.style.position="relative";this.ovDiv.style.zIndex=0;this.ovMapDiv.appendChild(this.ovDiv);this.registerEvent(this.ovDiv,'ov_','mousedown,mousemove,mouseup,click');this.rectDiv=Util.createDiv(Util.createUniqueID('rect_'),x,y,width/4,height/4,null,"absolute","2px solid blue");this.rectDiv.style.backgroundColor="white";this.rectDiv.style.filter="alpha(opacity=40)";this.rectDiv.style.opacity="0.40";this.rectDiv.style.fontSize="1px"
this.rectDiv.style.zIndex=10000;this.rectDiv.style.cursor="move";this.ovMapDiv.appendChild(this.rectDiv);this.registerEvent(this.rectDiv,'rect_','mousedown,mousemove,mouseup');this.panDiv=Util.createDiv(Util.createUniqueID('Ov_Pan_'),null,null,null,null,ImageBaseDir+'panel/arrowright1.gif','absolute');this.panDiv.style.zIndex=100000;this.panDiv.style.left=containerWidth-21;this.panDiv.style.top=containerHeight-21;this.panDiv.style.cursor="hand";this.container.appendChild(this.panDiv);this.registerEvent(this.panDiv,'pan_','click');},moveX:function(deltaX,direct){this.deltaXAixs=deltaX;if(Util.isIE()){if(direct=="left"){deltaX=deltaX+this.extX;}
else if(direct=="right"){deltaX=deltaX-this.extX;}}
this.ovMapDiv.style.left=Util.getValueOfNoPX(this.ovMapDiv.style.left)+deltaX;this.panDiv.style.left=Util.getValueOfNoPX(this.panDiv.style.left)+deltaX;},moveY:function(deltaY,direct){this.deltaYAixs=deltaY;if(direct=="up"){deltaY=-deltaY;}
else if(direct=="down"){deltaY=deltaY;}
this.ovMapDiv.style.top=Util.getValueOfNoPX(this.ovMapDiv.style.top)+deltaY;this.panDiv.style.top=Util.getValueOfNoPX(this.panDiv.style.top)+deltaY;},registerEvent:function(source,prefix,param){var params=param.split(',');if(params){for(var i=0;i<params.length;i++){Event.observe(source,params[i],eval('this.'+prefix+params[i]).bindAsEventListener(this));}}},getOvMapDiv:function(){return this.ovMapDiv;},getCurrentZoom:function(){return this.ovModel.getZoom();},pan_click:function(e){this.slide();Event.stop(e);},slide:function(){var ovMapDivLeft=Util.getValueOfNoPX(this.ovMapDiv.style.left);var ovMapDivTop=Util.getValueOfNoPX(this.ovMapDiv.style.top);if(state==1){state=0;this.panDiv.childNodes[0].src=ImageBaseDir+'panel/arrowright2.gif';this.ovMapDiv.style.display="none";}
else{state=1;this.panDiv.childNodes[0].src=ImageBaseDir+'panel/arrowright1.gif';this.ovMapDiv.style.display="";}},moveOvMapDiv:function(){var ovMapDivLeft=Util.getValueOfNoPX(this.ovMapDiv.style.left);var ovMapDivTop=Util.getValueOfNoPX(this.ovMapDiv.style.top);this.ovMapDiv.style.left=(ovMapDivLeft)+"px";this.ovMapDiv.style.top=(ovMapDivTop)+"px";},rect_mousedown:function(e){if(!this.isDragging)
this.isDragging=true;this.elm=Event.element(e);this.orgLeft=Util.getValueOfNoPX(this.elm.style.left);this.orgTop=Util.getValueOfNoPX(this.elm.style.top);this.orgMousePixel=Util.getMousePixel(e);var t_left=this.orgLeft;var t_top=this.orgTop;var t_width=this.elm.style.width;var t_height=this.elm.style.height;if(this.elm.setCapture){this.elm.setCapture();}
else
if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);}
this.rectTempDiv=Util.createDiv('rect_temp',t_left,t_top,t_width,t_height,null,"absolute","2px solid green");this.rectTempDiv.style.backgroundColor="lightyellow";this.rectTempDiv.style.filter="alpha(opacity=40)";this.rectTempDiv.style.opacity="0.40";this.rectTempDiv.style.fontSize="1px";this.rectTempDiv.style.zIndex=10000;this.rectTempDiv.style.cursor="move";var symble_focus=document.createTextNode("+");this.rectTempDiv.appendChild(symble_focus);this.elm.parentNode.appendChild(this.rectTempDiv);this.ini_x=this.orgLeft;this.ini_y=this.orgTop;Event.stop(e);},rect_mousemove:function(e){if(!this.isDragging||!this.orgMousePixel)
return;this.newMousePixel=Util.getMousePixel(e);var deltaX=this.newMousePixel.x-this.orgMousePixel.x;var deltaY=this.newMousePixel.y-this.orgMousePixel.y;this.elm.style.left=(this.orgLeft+deltaX)+"px";this.elm.style.top=(this.orgTop+deltaY)+"px";Event.stop(e);},rect_mouseup:function(e){if(this.elm.releaseCapture)
this.elm.releaseCapture();else
if(window.captureEvents)
window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);var lastMousePixel=Util.getMousePixel(e);var deltaX=lastMousePixel.x-this.orgMousePixel.x;var deltaY=lastMousePixel.y-this.orgMousePixel.y;var scale_use=Util.zoomScale(this.model.getOvModel().getZoom().getLevel())/Util.zoomScale(this.model.getZoom().getLevel());this.call_glide(this.rectDiv.id,Number(deltaX),Number(deltaY),scale_use);document.onmousemove=null;document.onmouseup=null;this.isDragging=false;Event.stop(e);},ov_mousedown:function(e){if(!this.isDragging)
this.isDragging=true;this.orgLeft=Util.getValueOfNoPX(this.ovDiv.style.left);this.orgTop=Util.getValueOfNoPX(this.ovDiv.style.top);this.orgMousePixel=Util.getMousePixel(e);if(this.ovDiv.setCapture)
this.ovDiv.setCapture();else
if(window.captureEvents)
window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);Event.stop(e);},ov_mousemove:function(e){if(!this.isDragging||!this.orgMousePixel)
return;this.newMousePixel=Util.getMousePixel(e);var deltaX=this.newMousePixel.x-this.orgMousePixel.x;var deltaY=this.newMousePixel.y-this.orgMousePixel.y;this.ovDiv.style.left=(this.orgLeft+deltaX)+"px";this.ovDiv.style.top=(this.orgTop+deltaY)+"px";var ini_main_map_x=Util.getValueOfNoPX(this.ovDiv.parentNode.parentNode.childNodes[0].style.left);var ini_main_map_y=Util.getValueOfNoPX(this.ovDiv.parentNode.parentNode.childNodes[0].style.top);Event.stop(e);},ov_mouseup:function(e){if(this.ovDiv.releaseCapture){this.ovDiv.releaseCapture();}
else if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);}
var lastMousePixel=Util.getMousePixel(e);var deltaX=lastMousePixel.x-this.orgMousePixel.x;var deltaY=lastMousePixel.y-this.orgMousePixel.y;this.reLoadTiles(this.model,deltaX,deltaY,true);document.onmousemove=null;document.onmouseup=null;this.isDragging=false;Event.stop(e);},ov_click:function(e){this.curMousePixel=Util.getMouseRelativePixel(e,this.ovDiv);this.curCenterPixel=Util.getScreenPixel(this.model.getOvModel().getViewCenterCoord(),this.model.getOvModel().getZoom());var deltaX=this.curCenterPixel.x-this.curMousePixel.x;var deltaY=this.curCenterPixel.y-this.curMousePixel.y;this.ovDiv.style.left=(Util.getValueOfNoPX(this.ovDiv.style.left)+deltaX)+"px";this.ovDiv.style.top=(Util.getValueOfNoPX(this.ovDiv.style.top)+deltaY)+"px";this.reLoadTiles(this.model,deltaX,deltaY,true);Event.stop(e);},reLoadTiles:function(model,deltaX,deltaY,isPlus){var scale=Util.zoomScale(model.getOvModel().getZoom().getLevel())/Util.zoomScale(model.getZoom().getLevel());var orgCenterCoord=model.getViewCenterCoord();var curZoom=model.getZoom();var realDeltaX=deltaX*scale*curZoom.realMapBound.getWidth()/(curZoom.getTileCols()*TileSize);var realDeltaY=deltaY*scale*curZoom.realMapBound.getHeight()/(curZoom.getTileRows()*TileSize);if(isPlus){x=orgCenterCoord.x-realDeltaX;y=orgCenterCoord.y+realDeltaY;}
else{x=orgCenterCoord.x+realDeltaX;y=orgCenterCoord.y-realDeltaY;}
var newCenterCoord=new Coordinate(x,y)
if(!newCenterCoord.isSame(orgCenterCoord)){model.setViewCenterCoord(newCenterCoord);this.loadTiles(model.getOvModel(),this.ovMapDiv,this.ovDiv,false);model.controls[this.container.childNodes[0].id].paint(model);}},call_glide:function(layerId,dest_x_t,dest_y_t,scale_t){this.reset();this.target=$(layerId);this.ini_x=Number(Util.getValueOfNoPX(this.target.style.left));this.ini_y=Number(Util.getValueOfNoPX(this.target.style.top));this.ini_x_map=Number(Util.getValueOfNoPX(this.target.parentNode.childNodes[0].style.left));this.ini_y_map=Number(Util.getValueOfNoPX(this.target.parentNode.childNodes[0].style.top));this.ini_x_main_map=Number(Util.getValueOfNoPX(this.target.parentNode.parentNode.childNodes[0].style.left));this.ini_y_main_map=Number(Util.getValueOfNoPX(this.target.parentNode.parentNode.childNodes[0].style.top));this.glide((-dest_x_t),(-dest_y_t),scale_t);},glide:function(dest_x,dest_y,scale_test){if(this.target){var coefficient=12;var dist_x,dist_y;if(dest_y!=0&&this.y_moved!=dest_y){dist_y=(Math.max(Math.abs(this.y_moved),Math.abs(dest_y))-Math.min(Math.abs(this.y_moved),Math.abs(dest_y)));if(dist_y<Math.abs(dest_y/coefficient)){this.y_moved=dest_y;this.control_mark=1;}
else{this.y_moved=this.y_moved+dest_y/coefficient;this.target.style.top=(this.ini_y+this.y_moved)+"px";this.target.parentNode.childNodes[0].style.top=(this.ini_y_map+this.y_moved)+"px";this.target.parentNode.parentNode.childNodes[0].style.top=(this.ini_y_main_map+this.y_moved*scale_test)+"px";this.control_mark=2;}}
if(dest_x!=0&&this.x_moved!=dest_x){dist_x=(Math.max(Math.abs(this.x_moved),Math.abs(dest_x))-Math.min(Math.abs(this.x_moved),Math.abs(dest_x)));if(this.control_mark==1||dist_x<Math.abs(dest_x/coefficient)){this.x_moved=dest_x;this.control_mark=1;before_move=new Date();}
else{this.x_moved=this.x_moved+dest_x/coefficient;this.target.style.left=(this.ini_x+this.x_moved)+"px";this.target.parentNode.childNodes[0].style.left=(this.ini_x_map+this.x_moved)+"px";this.target.parentNode.parentNode.childNodes[0].style.left=(this.ini_x_main_map+this.x_moved*scale_test)+"px";this.control_mark=2;}}
if(this.control_mark==2){this.glide_timer=setTimeout(function(){this.glide(dest_x,dest_y,scale_test);}.bind(this),1);}
else
if(this.control_mark==1){this.target.style.left=(this.ini_x+dest_x)+"px";this.target.style.top=(this.ini_y+dest_y)+"px";this.target.parentNode.childNodes[0].style.left=(this.ini_x_map+this.x_moved)+"px";this.target.parentNode.childNodes[0].style.top=(this.ini_y_map+this.y_moved)+"px";this.target.parentNode.parentNode.childNodes[0].style.left=(this.ini_x_main_map+this.x_moved*scale_test)+"px";this.target.parentNode.parentNode.childNodes[0].style.top=(this.ini_y_main_map+this.y_moved*scale_test)+"px";this.target.parentNode.removeChild(document.getElementById("rect_temp"));clearTimeout(this.glide_timer);this.reset();}
else{if(document.getElementById("rect_temp"))
this.target.parentNode.removeChild(document.getElementById("rect_temp"));}
if(this.control_mark<2){setTimeout(function(){this.reLoadTiles(this.model,-dest_x,-dest_y,false);}.bind(this),1);}
this.control_mark=0;dist_x=0;dist_y=0;}},reset:function(){this.x_moved=0;this.y_moved=0;this.ini_x=0;this.ini_y=0;this.ini_x_map=0;this.ini_y_map=0;this.ini_x_main_map=0;this.ini_y_main_map=0;this.target=null;this.control_mark=0;this.glide_timer=null;}});
NavControl=Class.create();NavControl.prototype=Object.extend(new Abstract.Control(),{initialize:function(container){this.container=container;this.drawNavControl();},paint:function(model){this.model=model;var html='<table border="0" cellspacing="0" cellpadding="1"><tr><td align="center" colspan="3">';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_goup.gif" id="goup_'+this.model.getId()+'"></td></tr><tr><td>';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_goleft.gif" id="goleft_'+this.model.getId()+'"></td><td>';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_default.gif" id="reset_'+this.model.getId()+'"></td><td>';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_goright.gif" id="goright_'+this.model.getId()+'"></td></tr><tr><td align="center" colspan="3">';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_godown.gif" id="godown_'+this.model.getId()+'"></td></tr><tr><td height="5"></td></tr><tr><td align="center" colspan="3"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center">';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_zoomin.gif" id="zoomin_'+this.model.getId()+'"></td></tr><tr>';html+='<td style="height:2px;" id="map'+this.model.getId()+'_sliderbar" align="center" onmousedown="return false;"></td></tr><tr><td align="center">';html+='<img style="cursor:pointer" src="'+ImageBaseDir+'icon_zoomout.gif" id="zoomout_'+this.model.getId()+'"></td></tr></table></td></tr></table>';this.navToolDiv.innerHTML=html;html='<div style="position:relative;height:'+(MaxZoomLevel*12+9)+'px;width:18px;z-index:100;overflow:hidden;" onmousedown="return false;">';for(var i=0;i<=MaxZoomLevel;i++){html+='<img src="'+ImageBaseDir+'zoom_bar.gif">';}
html+='<div style="position:absolute;top:'+((MaxZoomLevel-this.model.getZoom().getLevel())*12+6)+'px;left:0px;z-index:100;">';html+='<img src="'+ImageBaseDir+'slider.gif" id="sliderbar_'+this.model.getId()+'"></div></div>';var sliderbar=$('map'+this.model.getId()+'_sliderbar');sliderbar.innerHTML=html;this.registerEventToNav("goup_,goleft_,goright_,godown_,reset_,zoomin_,zoomout_");this.registerEventToSlider("sliderbar_","mousedown,mousemove,mouseup");},loadTiles:function(){},registerEventToNav:function(str){var eventNames=str.split(',');for(var i=0;i<eventNames.length;i++){var source=$(eventNames[i]+this.model.getId());Event.observe(source,"click",this.navClickHandler.bindAsEventListener(this));}},registerEventToSlider:function(id,eventTypes){var source=$(id+this.model.getId());eventTypes=eventTypes.split(',');Event.observe(source,eventTypes[0],this.sliderDownHandler.bindAsEventListener(this));Event.observe(source,eventTypes[1],this.sliderMoveHandler.bindAsEventListener(this));Event.observe(source,eventTypes[2],this.sliderUpHandler.bindAsEventListener(this));},drawNavControl:function(){var left=Util.getValueOfNoPX(this.container.style.left)+20;var top=Util.getValueOfNoPX(this.container.style.top)+60;this.id=Util.createUniqueID('Nav_');this.navToolDiv=Util.createDiv(this.id,left,top,null,null,null,'absolute','0px solid blue');this.navToolDiv.style.zIndex=2000;this.container.appendChild(this.navToolDiv);},navClickHandler:function(e){var param=Event.element(e).id.split('_')[0];if(param!=null){var newX=this.model.getViewCenterCoord().x;var newY=this.model.getViewCenterCoord().y;if(param=="goup"){newY=this.model.getViewCenterCoord().y+this.model.getZoom().getViewBound(this.container).getHeight()/2;}
if(param=="godown"){newY=this.model.getViewCenterCoord().y-this.model.getZoom().getViewBound(this.container).getHeight()/2;}
if(param=="goleft"){newX=this.model.getViewCenterCoord().x-this.model.getZoom().getViewBound(this.container).getWidth()/2;}
if(param=="goright"){newX=this.model.getViewCenterCoord().x+this.model.getZoom().getViewBound(this.container).getWidth()/2;}
if(param=="zoomin"){this.zoomin($('sliderbar_'+this.model.getId()).parentNode);Event.stop(e);return;}
if(param=="zoomout"){this.zoomout($('sliderbar_'+this.model.getId()).parentNode);Event.stop(e);return;}
if(param=="reset"){this.reset($('sliderbar_'+this.model.getId()).parentNode);Event.stop(e);return;}
var newCoord=new Coordinate(newX,newY);if(!newCoord.isSame(this.model.getViewCenterCoord())){this.model.setViewCenterCoord(newCoord);this.model.controls[this.container.childNodes[0].id].paint(this.model,true);this.model.controls[this.model.ovId].paint(this.model);}
Event.stop(e);}},zoomin:function(elm){var level=this.model.getZoom().getLevel();if(level<MaxZoomLevel){this.model.setZoom(new Zoom(level+1));this.model.controls[this.container.childNodes[0].id].paint(this.model,true);this.model.controls[this.model.ovId].paint(this.model);elm.style.top=((MaxZoomLevel-(level+1))*12+6)+"px";}},zoomout:function(elm){var level=this.model.getZoom().getLevel();if(level>1){this.model.setZoom(new Zoom(level-1));this.model.controls[this.container.childNodes[0].id].paint(this.model,true);this.model.controls[this.model.ovId].paint(this.model);elm.style.top=((MaxZoomLevel-(level-1))*12+6)+"px";}},reset:function(elm){this.model.reset(this.container.childNodes[0],elm);},sliderDownHandler:function(e){if(!this.isDragging)
this.isDragging=true;this.elm=Event.element(e);this.orgTop=Util.getValueOfNoPX(this.elm.parentNode.style.top);this.elm.style.cursor='pointer';this.orgMousePixel=Util.getMousePixel(e);if(this.elm.setCapture){this.elm.setCapture();}
else{if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);}}},sliderMoveHandler:function(e){if(!this.isDragging){return;}
this.newMousePixel=Util.getMousePixel(e);var top=this.orgTop+this.newMousePixel.y-this.orgMousePixel.y;if(top>0&&top<MaxZoomLevel*12){this.elm.parentNode.style.top=top+"px";}},sliderUpHandler:function(e){if(this.isDragging)
this.isDragging=false;if(this.elm.releaseCapture){this.elm.releaseCapture();}
else
if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);}
document.onmousemove=function(){return false;};document.onmouseup=function(){return false;};this.elm.style.cursor="";var sliderLevel=Math.floor(Util.getValueOfNoPX(this.elm.parentNode.style.top)/12);var sliderTop=sliderLevel*12+6;this.elm.parentNode.style.top=sliderTop+"px";this.sliderZoom(MaxZoomLevel-sliderLevel);},sliderZoom:function(newLevel){var level=this.model.getZoom().getLevel();if(newLevel>MaxZoomLevel){newLevel=MaxZoomLevel;}
if(level!=newLevel){this.model.setZoom(new Zoom(newLevel));this.model.controls[this.container.childNodes[0].id].paint(this.model,true);this.model.controls[this.model.ovId].paint(this.model);}}});
ScaleControl=Class.create();ScaleControl.prototype={initialize:function(container){this.id=Util.createUniqueID('Scale_');this.scaleDiv=this.create(container);container.appendChild(this.scaleDiv);},create:function(container){var left=Util.getValueOfNoPX(container.style.left)+300;var top=Util.getValueOfNoPX(container.style.top)+Util.getValueOfNoPX(container.style.height)-30;var div=Util.createDiv(this.scaleId,left,top,null,null,null,'absolute');var scaleInfo=Util.createDiv(null,left-8,top,150,null,ImageBaseDir+'scale.gif','absolute');container.appendChild(scaleInfo);div.style.fontSize="12px";div.innerHTML='<div id="scaleInfo" style="padding:3px;z-index:10;vertical-align:bottom;">&nbsp;</div>';return div;}};
MapControl=Class.create();MapControl.prototype=Object.extend(new Abstract.Control(),{initialize:function(id,container){this.id=id;this.mapDiv=Util.createDiv(id);this.mapDiv.style.position="absolute";this.mapDiv.style.zIndex=0;this.mapDiv.style.cursor="move";this.vmlDiv=Util.createDiv("vmlDiv");this.vmlDiv.style.position="absolute";this.vmlDiv.style.zIndex=0;this.container=container;this.container.style.border="1px solid #666666";this.container.style.overflow="hidden";this.container.style.position="relative";this.container.appendChild(this.mapDiv);this.container.appendChild(this.vmlDiv);},paint:function(model,isTracing){var curZoom=model.getZoom();var viewBound=curZoom.getViewBound(this.container).clone(model.getViewCenterCoord());var mapBound=curZoom.realMapBound;var deltaX=(mapBound.getMinX()-viewBound.getMinX())*(curZoom.getTileCols()*TileSize/mapBound.getWidth());var deltaY=(viewBound.getMaxY()-mapBound.getMaxY())*(curZoom.getTileRows()*TileSize/mapBound.getHeight());this.mapDiv.style.left=deltaX+"px";this.mapDiv.style.top=deltaY+"px";this.mapDiv.style.width=(curZoom.getTileCols()*TileSize)+"px";this.mapDiv.style.height=(curZoom.getTileRows()*TileSize)+"px";this.vmlDiv.style.left=deltaX+"px";this.vmlDiv.style.top=deltaY+"px";this.vmlDiv.style.width=(curZoom.getTileCols()*TileSize)+"px";this.vmlDiv.style.height=(curZoom.getTileRows()*TileSize)+"px";this.loadTiles(model,this.container,this.mapDiv,isTracing,true);},getMapDiv:function(){return this.mapDiv;},getVMLDiv:function(){return this.vmlDiv;}});
ToolBarControl=Class.create();ToolBarControl.prototype={EVENT_TYPES:["mouseover","mouseout","mousemove","mousedown","mouseup","dblclick","click"],initialize:function(container){this.barlength=0;this.container=container;this.bar=Util.createDiv(Util.createUniqueID('Tool_'));this.tools=new Object();this.currentTool=null;this.model=null;},paint:function(model){this.model=model;this.bar.style.position="relative";this.bar.style.zIndex=100;this.bar.style.left=-30;this.bar.style.top=-40;this.container.appendChild(this.bar);},addTool:function(tool,isDefault){if(!tool){return;}
this.tools[tool.id]=tool;this.bar.appendChild(tool.div);if(isDefault){this.currentTool=tool;this.defaultTool=tool;}
Event.observe(tool.div,"mouseout",tool.barMouseOutHandler.bindAsEventListener(this));Event.observe(tool.div,"mouseover",tool.barMouseOverHandler.bindAsEventListener(this));Event.observe(tool.div,"click",tool.barClickHandler.bindAsEventListener(this));this.barlength=this.barlength+1;},removeTool:function(divid)
{if(divid!=null&&Util.trim(divid)!='')
{if(this.barlength>0)
{this.bar.removeChild(this.tools[divid].div);this.barlength=this.barlength-1;}}
return null;},addCommand:function(cmd){if(!cmd){return;}
this.tools[cmd.id]=cmd;this.bar.appendChild(cmd.div);Event.observe(cmd.div,"mouseout",cmd.cmdMouseOutHandler.bindAsEventListener(this));Event.observe(cmd.div,"mouseover",cmd.cmdMouseOverHandler.bindAsEventListener(this));Event.observe(cmd.div,"click",cmd.cmdClickHandler.bindAsEventListener(this));this.barlength=this.barlength+1;},setMapModel:function(model){this.model=model;},clearCurrentToolStatus:function(){var toolDivs=this.bar.childNodes;for(var i=0;i<toolDivs.length;i++){var tool=this.tools[toolDivs[i].id];if(tool.selected==true){tool.selected=false;toolDivs[i].childNodes[0].src=tool.img_normal;}}},registerEventToMap:function(mapDiv){this.mapDiv=mapDiv;Event.observe(mapDiv,"mousedown",this.mapMouseDownHandler.bindAsEventListener(this));Event.observe(mapDiv,"mousemove",this.mapMouseMoveHandler.bindAsEventListener(this));Event.observe(mapDiv,"mouseup",this.mapMouseUpHandler.bindAsEventListener(this));Event.observe(mapDiv,"dblclick",this.mapDblclickHandler.bindAsEventListener(this));Event.observe(mapDiv,"click",this.mapClickHandler.bindAsEventListener(this));},checkNav:function(e){var currElement=Event.element(e);var currId=currElement.id;if(currId==""||currId=="map"||currId=="vmlDiv"||currId=="zoomBox"){return false;}
if(currId!=null){var tmpIdArr=currId.split("_");if(tmpIdArr[0]=="sliderbar"){return true;}}
return true;},mapMouseDownHandler:function(e){if(this.currentTool==null||this.tools[this.currentTool.id].toolType=="Command"){return;}
this.tools[this.currentTool.id].mouseDownHandler(e,this);},mapMouseMoveHandler:function(e){if(this.currentTool==null||this.tools[this.currentTool.id].toolType=="Command"){return;}
this.tools[this.currentTool.id].mouseMoveHandler(e,this);},mapMouseUpHandler:function(e){if(this.currentTool==null||this.tools[this.currentTool.id].toolType=="Command"){return;}
this.tools[this.currentTool.id].mouseUpHandler(e,this);},mapClickHandler:function(e){if(this.currentTool==null||this.tools[this.currentTool.id].toolType=="Command"){return;}
this.tools[this.currentTool.id].clickHandler(e,this);},mapDblclickHandler:function(e){if(this.currentTool==null||this.tools[this.currentTool.id].toolType=="Command"){return;}
this.tools[this.currentTool.id].dblClickHandler(e,this);},addDefaultToolBar:function(imgPath)
{imgPath=imgPath+'mapTools/';this.addTool(new ZoominTool('zoomin',imgPath+'zoomin1.gif',imgPath+'zoomin2.gif',imgPath+'zoomin3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addTool(new ZoomoutTool('zoomout',imgPath+'zoomout1.gif',imgPath+'zoomout2.gif',imgPath+'zoomout3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addTool(new PanTool('pan',imgPath+'pan1.gif',imgPath+'pan2.gif',imgPath+'pan3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25),true)
this.addTool(new MeasureTool('measure',imgPath+'measure1.gif',imgPath+'measure2.gif',imgPath+'measure3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addTool(new LabelTool('labeltool',imgPath+'label1.gif',imgPath+'label2.gif',imgPath+'label3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addCommand(new ClearCmd('clear',imgPath+'clear1.gif',imgPath+'clear2.gif',imgPath+'clear3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addCommand(new FullCmd('full',imgPath+'full1.gif',imgPath+'full2.gif',imgPath+'full3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addCommand(new SearchCmd('browse',imgPath+'browse1.gif',imgPath+'browse2.gif',imgPath+'browse3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addCommand(new PrevCmd('back',imgPath+'back1.gif',imgPath+'back2.gif',imgPath+'back3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))
this.addCommand(new NextCmd('forward',imgPath+'forward1.gif',imgPath+'forward2.gif',imgPath+'forward3.gif','absolute',1+toolInterval*(this.barlength+1),35,28,25))},toPan:function(){this.clearCurrentToolStatus();var tool=this.tools['pan'];tool.div.childNodes[0].src=tool.img_down;if(!tool.selected){tool.selected=true;this.currentTool=tool;this.mapDiv.style.cursor=tool.cursorStyle;}}};
CRightPanelControl=Class.create();CRightPanelControl.prototype=Object.extend(new Abstract.Control(),{expand:false,contentArr:null,currWidth:0,currExpand:null,initialize:function(container,ovMap,pwidth,btnWidth,btnHeight){this.contentArr=new Array();this.itemArr=new Array();this.container=container;this.pWidth=pwidth;this.btnWidth=btnWidth;this.btnHeight=btnHeight;this.ovMap=ovMap;this.containerWidth=Util.getValueOfNoPX(container.style.width);this.containerHeight=Util.getValueOfNoPX(container.style.height);this.drawCRightPanelContainer(container);},paint:function(model){this.model=model;this.cPanelDiv.style.left=(this.containerWidth-22)+"px";this.cPanelDiv.style.width="0px";this.cPanelDiv.style.zIndex="10";this.cPanelDiv.style.visibility="visible";this.cPanelContentDiv.style.display="none";this.cPanelDiv.style.height=this.containerHeight-1;this.container.appendChild(this.cPanelDiv);},drawCRightPanelContainer:function(container){var width=this.pWidth;var height=this.containerHeight-1;var left=this.containerWidth-this.pWidth+1;var top=0;this.id="rightContentPanel";this.cPanelDiv=Util.createDiv(this.id,left,top,width,height,null,'absolute');this.cPanelDiv.style.zIndex="0";this.cPanelButtonDiv=Util.createDiv("CPButton");this.cPanelButtonDiv.style.cssFloat="left";this.cPanelButtonDiv.style.styleFloat="left";this.cPanelButtonDiv.style.padding="0px 0px 0px 0px";this.cPanelButtonDiv.style.margin="0px";this.cPanelButtonDiv.style.width=this.btnWidth;this.cPanelButtonDiv.style.height=this.btnHeight;this.cPanelButtonDiv.overflow="hidden";this.cPanelButtonDiv.zIndex="10000";this.addCtrlBtn();this.cPanelDiv.appendChild(this.cPanelButtonDiv);this.cPanelContentDiv=Util.createDiv("CPContent",0,0,0,0,null,null,'1px ridge black');this.cPanelContentDiv.style.padding="0px 0px 0px 0px";this.cPanelContentDiv.style.margin="0px";this.cPanelContentDiv.style.height="100%";this.cPanelContentDiv.style.width="100%";this.cPanelDiv.appendChild(this.cPanelContentDiv);},setBottomControlPanel:function(cbpControl){this.cbpControl=cbpControl;},getContentPanelDiv:function(){return this.cPanelDiv;},addCtrlBtn:function(){this.ctrlBtnDiv=Util.createDiv("ctrlBtn",0,0,15,15);var imgsrc=ImageBaseDir+"panel/left.gif";this.ctrlImg=Util.createImg('ctrlBtn_Img',0,0,15,15,imgsrc,'relative');this.ctrlImg.style.cursor="pointer";this.ctrlBtnDiv.appendChild(this.ctrlImg);this.registerEvent(this.ctrlImg,'img_','click');this.cPanelButtonDiv.appendChild(this.ctrlBtnDiv);},addItem:function(cpItem){cpItem.create();var nowItem=cpItem.getItem();this.itemArr[this.itemArr.length]=cpItem;this.registerEvent(nowItem,'Item_','click');this.cPanelButtonDiv.appendChild(nowItem);},addContent:function(cpContent){cpContent.create();var nowContent=cpContent.getContent();this.contentArr[this.contentArr.length]=nowContent;this.cPanelContentDiv.appendChild(nowContent);},registerEvent:function(source,prefix,param){var params=param.split(',');if(params){for(var i=0;i<params.length;i++){Event.observe(source,params[i],eval('this.'+prefix+params[i]).bindAsEventListener(this));}}},Item_click:function(e){var itemId="";if(e.target){itemId=e.target.id;}
else{itemId=e.srcElement.id;}
this.currItemID=itemId;this.setStatus(itemId,-1);this.fireExpand(itemId);Event.stop(e);},setStatus:function(itemId,index){if(this.contentArr!=null&&this.contentArr!=""){for(var i=0;i<this.contentArr.length;i++){var tmpId=this.contentArr[i].id;if((tmpId==(itemId+"_content"))||i==index){this.contentArr[i].style.display="";this.itemArr[i].activeItem();}
else{this.contentArr[i].style.display="none";this.itemArr[i].deActiveItem();}}}},fireImgBtnExpand:function(contentItemId){if(this.expand==false){if(this.contentArr!=null&&this.contentArr!=""){this.setStatus(null,0);var tmpId=this.contentArr[0].id;var itemidArr=tmpId.split("_");this.currExpand=itemidArr[0];this.doExpand();this.expand=true;}}
else{this.setStatus(null,-1);this.doDisExpand();this.expand=false;this.currExpand=null;}},img_click:function(e){this.currItemID=this.itemArr[0].id;this.fireImgBtnExpand();Event.stop(e);},fireExpand:function(itemId){if(this.expand==false){this.doExpand();this.currExpand=itemId;this.expand=true;}
else{if(this.currExpand==itemId){this.doDisExpand();this.expand=false;}
else{this.currExpand=itemId;this.expand=true;}}},doExpand:function(){var leftpx=this.cPanelDiv.style.left;var leftnopx=Util.getValueOfNoPX(leftpx);this.ctrlImg.src=ImageBaseDir+"panel/right.gif";this.ctrlImg.style.width="15";this.ctrlImg.style.height="15";this.ctrlImg.align="middle";this.cPanelDiv.style.width=this.pWidth+"px";this.cPanelDiv.style.left=(this.containerWidth-this.pWidth)+"px";this.cPanelContentDiv.style.display="";this.ovMap.moveX(-this.pWidth,"left");this.currWidth=this.pWidth;if(this.cbpControl)
{this.cbpControl.fireDynamicWidth();}},doDisExpand:function(){var leftpx=this.cPanelDiv.style.left;var leftnopx=Util.getValueOfNoPX(leftpx);this.ctrlImg.src=ImageBaseDir+"panel/left.gif";this.cPanelDiv.style.left=(this.containerWidth-22)+"px";this.cPanelDiv.style.width="0px";this.cPanelContentDiv.style.display="none";this.ovMap.moveX(this.pWidth,"right");this.currWidth=0;if(this.cbpControl)
{this.cbpControl.fireDynamicWidth();}},getCurrWidth:function(){return this.currWidth;},getCurrItemID:function(){return this.currItemID;}});
CBPanelControl=Class.create();CBPanelControl.prototype=Object.extend(new Abstract.Control(),{initialize:function(container,pWidth,pHeight,ovMap,crpControl){this.container=container;this.pWidth=pWidth;this.pHeight=pHeight;this.ovMap=ovMap;this.crpControl=crpControl;this.extX=22;this.ovMapDiv=this.ovMap.getOvMapDiv();this.drawCBPContainer(container);},paint:function(model){this.model=model;this.container.appendChild(this.bPanelDiv);},drawCBPContainer:function(container){this.containerWidth=Util.getValueOfNoPX(container.style.width);this.containerHeight=Util.getValueOfNoPX(container.style.height);var width=this.pWidth;var height=this.pHeight;var left=0;var top=this.containerHeight+1;this.id=Util.createUniqueID('Bottom_');this.bPanelDiv=Util.createDiv(this.id,left,top,width,height,null,'absolute','1px ridge black');this.bPanelDiv.style.overflow='hidden';this.bPanelDiv.style.display='none';this.panDiv=Util.createDiv(Util.createUniqueID('Bottom_Pan_'),null,null,null,null,ImageBaseDir+'panel/arrow2.gif','absolute');this.panDiv.style.zIndex=100000;this.panDiv.style.left=0;this.panDiv.style.top=this.containerHeight-25;this.panDiv.style.cursor="hand";this.container.appendChild(this.panDiv);this.registerEvent(this.panDiv,'pan_','click');},getCurrHeight:function(){return Util.getValueOfNoPX(this.bPanelDiv.style.height);},registerEvent:function(source,prefix,param){var params=param.split(',');if(params){for(var i=0;i<params.length;i++){Event.observe(source,params[i],eval('this.'+prefix+params[i]).bindAsEventListener(this));}}},pan_click:function(e){this.fExpand(Util.getValueOfNoPX(this.bPanelDiv.style.width)-1,Util.getValueOfNoPX(this.bPanelDiv.style.height)-1,this.panDiv.childNodes[0]);Event.stop(e);},fExpand:function(w,h,img){if(this.bPanelDiv.style.display=="inline"){this.doExpand(0,this.containerHeight);img.src=ImageBaseDir+'panel/arrow2.gif';}
else{this.doExpand(0,this.containerHeight-h);img.src=ImageBaseDir+'panel/arrow1.gif';}},doExpand:function(left,top){this.bPanelDiv.style.left=left;this.bPanelDiv.style.top=top;if(Util.isIE()){if(this.crpControl!=null)
{this.bPanelDiv.style.width=this.pWidth-this.crpControl.getCurrWidth()+this.extX+1;}
else
{this.bPanelDiv.style.width=this.pWidth;}}
else{if(this.crpControl!=null)
{this.bPanelDiv.style.width=this.pWidth-this.crpControl.getCurrWidth()-5;}
else
{this.bPanelDiv.style.width=this.pWidth-5;}}
if(this.bPanelDiv.style.display=="none"){this.bPanelDiv.style.display="inline";}
else{this.bPanelDiv.style.display="none";}},doShowExpand:function()
{this.bPanelDiv.style.left=0;this.bPanelDiv.style.top=this.containerHeight-this.pHeight;if(Util.isIE()){if(this.crpControl!=null)
{this.bPanelDiv.style.width=this.pWidth-this.crpControl.getCurrWidth()+this.extX+1;}
else
{this.bPanelDiv.style.width=this.pWidth;}}
else{if(this.crpControl!=null)
{this.bPanelDiv.style.width=this.pWidth-this.crpControl.getCurrWidth()-5;}
else
{this.bPanelDiv.style.width=this.pWidth-5;}}
if(this.bPanelDiv.style.display=="none"){this.bPanelDiv.style.display="inline";}},addContent:function(cpContent){cpContent.create();this.cpContentDiv=cpContent.getContent();this.bPanelDiv.appendChild(this.cpContentDiv);},addHtml:function(html){this.cpContentDiv.innerHTML=html;},fireDynamicWidth:function(){if(Util.isIE()){this.bPanelDiv.style.width=this.containerWidth-this.crpControl.getCurrWidth()+this.extX+1;}
else{this.bPanelDiv.style.width=this.containerWidth-this.crpControl.getCurrWidth()-5;}}});
Abstract.Tool=function(){}
Abstract.Tool.prototype={initialize:function(id,img1,img2,img3,pos,left,top,width,height){this.toolType="Tool";this.id=id;this.img_normal=img1;this.img_over=img2;this.img_down=img3;this.position=pos;this.left=parseInt(left);this.top=parseInt(top);this.width=parseInt(width);this.height=parseInt(height);this.div=Util.createDiv(this.id,this.left,this.top,this.width,this.height,this.img_normal,this.position,'0px solid #ccc');this.div.style.cursor="pointer";},mouseDownHandler:function(e,toolbar){},mouseMoveHandler:function(e,toolbar){},mouseUpHandler:function(e,toolbar){},clickHandler:function(e,toolbar){Event.stop(e);},dblClickHandler:function(e,toolbar){},barClickHandler:function(e){var elm=Event.element(e);if(elm.childNodes.length>0)return;this.clearCurrentToolStatus();var tool=this.tools[Event.element(e).parentNode.id];tool.div.childNodes[0].src=tool.img_down;if(!tool.selected){tool.selected=true;this.currentTool=tool;this.mapDiv.style.cursor=tool.cursorStyle;}
Event.stop(e);},barMouseOverHandler:function(e){var elm=Event.element(e);if(elm.childNodes.length>0){return;}
if(this.tools[elm.parentNode.id].selected==true)
return;elm.src=this.tools[elm.parentNode.id].img_over;elm.alt=this.tools[elm.parentNode.id].alt;Event.stop(e);},barMouseOutHandler:function(e){var elm=Event.element(e);if(elm.childNodes.length>0)
return;if(this.tools[elm.parentNode.id].selected==true)
return;elm.src=this.tools[elm.parentNode.id].img_normal;Event.stop(e);},zoomToExtent:function(model,extent,container,direction){if(extent){var zoom=model.getZoom();var w1=zoom.getViewBound(container).getPixelWidth(zoom);var h1=zoom.getViewBound(container).getPixelHeight(zoom);var w2=extent.getPixelWidth(zoom);var h2=extent.getPixelHeight(zoom);var r1=Math.sqrt(w1*w1+h1*h1);var r2=Math.sqrt(w2*w2+h2*h2);var deltalLevel=Math.floor(r1/r2);if(w2<1||h2<1)
return;var orgLevel=zoom.getLevel();if(deltalLevel>3)deltalLevel=3;switch(direction){case'zoomin':orgLevel+=deltalLevel;if(orgLevel>MaxZoomLevel)orgLevel=MaxZoomLevel;break;case'zoomout':orgLevel-=deltalLevel;if(orgLevel<1)orgLevel=1;break;}
model.setZoom(new Zoom(orgLevel));model.setViewCenterCoord(extent.getCenter());model.controls[container.childNodes[0].id].paint(model,true);if(typeof(ovmap)!="undefined")
{model.controls[model.ovId].paint(model);}
if(typeof(navControl)!="undefined")
{$('sliderbar_'+model.getId()).parentNode.style.top=((MaxZoomLevel-orgLevel)*12+6)+"px";}}}};PanTool=Class.create();PanTool.prototype=Object.extend(new Abstract.Tool(),{cursorStyle:'move',selected:false,alt:'移屏',mouseDownHandler:function(e,toolbar){this.mapDiv=toolbar.mapDiv;if(!this.mapDiv)
return;if(!this.isDrag)
this.isDrag=true;this.orgPixelX=Util.getValueOfNoPX(this.mapDiv.style.left);this.orgPixelY=Util.getValueOfNoPX(this.mapDiv.style.top);this.vmlDiv=map.getVMLDiv();this.orgVMLPixelX=Util.getValueOfNoPX(vmlDiv.style.left);this.orgVMLPixelY=Util.getValueOfNoPX(vmlDiv.style.top);this.orgMousePixel=Util.getMousePixel(e);if(this.mapDiv.setCapture)
this.mapDiv.setCapture();else if(window.captureEvents)
window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);document.onselectstart=function(){return false};Event.stop(e);},mouseMoveHandler:function(e,toolbar){if(this.orgMousePixel==null||this.isDrag==false||!this.mapDiv)
return;this.newMousePixel=Util.getMousePixel(e);var deltaX=this.newMousePixel.x-this.orgMousePixel.x;var deltaY=this.newMousePixel.y-this.orgMousePixel.y;this.mapDiv.style.left=(this.orgPixelX+deltaX)+"px";this.mapDiv.style.top=(this.orgPixelY+deltaY)+"px";this.vmlDiv.style.left=(this.orgVMLPixelX+deltaX)+"px";this.vmlDiv.style.top=(this.orgVMLPixelY+deltaY)+"px";Event.stop(e);},mouseUpHandler:function(e,toolbar){if(!this.isDrag)return;if(!this.mapDiv)
return;if(this.mapDiv.releaseCapture)
this.mapDiv.releaseCapture();else if(window.captureEvents)
window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);var lastMousePixel=Util.getMousePixel(e);var deltaX=lastMousePixel.x-this.orgMousePixel.x;var deltaY=lastMousePixel.y-this.orgMousePixel.y;if(deltaX!=0||deltaY!=0){this.reLoadTiles(toolbar.model,deltaX,deltaY,this.mapDiv);}
document.onmousemove=null;document.onmouseup=null;this.isDrag=false;Event.stop(e);},reLoadTiles:function(model,deltaX,deltaY,mapDiv){var orgCenterCoord=model.getViewCenterCoord();var curZoom=model.getZoom();var x=orgCenterCoord.x-deltaX*curZoom.realMapBound.getWidth()/(curZoom.getTileCols()*TileSize);var y=orgCenterCoord.y+deltaY*curZoom.realMapBound.getHeight()/(curZoom.getTileRows()*TileSize);var newCenterCoord=new Coordinate(x,y);if(!newCenterCoord.isSame(orgCenterCoord))
model.setViewCenterCoord(newCenterCoord);var control=new Abstract.Control();control.loadTiles(model,mapDiv.parentNode,mapDiv,true,true);if(typeof(ovmap)!="undefined")
{model.controls[model.ovId].paint(model);}},clickHandler:function(e,toolbar){Event.stop(e);},dblClickHandler:function(e,toolbar){var point=Util.getCoordinateByPixel(Util.getMousePixel(e),toolbar.model.zoom).getPoint();var infoCoord=Util.getMouseRelativePixel(e,this.mapDiv);Event.stop(e);}});ZoominTool=Class.create();ZoominTool.prototype=Object.extend(new Abstract.Tool(),{cursorStyle:'url("images/zoomin.cur")',selected:false,alt:'拉框放大',mouseDownHandler:function(e,toolbar){this.mapDiv=toolbar.mapDiv;this.mouseDownPixel=Util.getMouseRelativePixel(e,this.mapDiv);this.zoomBox=Util.createDiv('zoomBox',this.mouseDownPixel.x,this.mouseDownPixel.y,null,null,null,"absolute","1px solid red");this.zoomBox.style.backgroundColor="white";this.zoomBox.style.filter="alpha(opacity=50)";this.zoomBox.style.opacity="0.50";this.zoomBox.style.fontSize="1px";this.mapDiv.appendChild(this.zoomBox);Event.stop(e);},mouseMoveHandler:function(e,toolbar){this.mapDiv=toolbar.mapDiv;this.mouseMovePixel=Util.getMouseRelativePixel(e,this.mapDiv);if(this.mouseDownPixel){var deltaX=Math.abs(this.mouseDownPixel.x-this.mouseMovePixel.x);var deltaY=Math.abs(this.mouseDownPixel.y-this.mouseMovePixel.y);this.zoomBox.style.width=Math.max(1,deltaX)+"px";this.zoomBox.style.height=Math.max(1,deltaY)+"px";if(this.mouseMovePixel.x<this.mouseDownPixel.x)
this.zoomBox.style.left=this.mouseMovePixel.x+"px";if(this.mouseMovePixel.y<this.mouseDownPixel.y)
this.zoomBox.style.top=this.mouseMovePixel.y+"px";}
Event.stop(e);},mouseUpHandler:function(e,toolbar){if(this.mouseDownPixel&&this.mouseMovePixel){var top=Math.min(this.mouseDownPixel.y,this.mouseMovePixel.y);var bottom=Math.max(this.mouseDownPixel.y,this.mouseMovePixel.y);var left=Math.min(this.mouseDownPixel.x,this.mouseMovePixel.x);var right=Math.max(this.mouseDownPixel.x,this.mouseMovePixel.x);var leftTop=Util.getCoordinateByPixel({x:left,y:top},toolbar.model.getZoom());var rightbottom=Util.getCoordinateByPixel({x:right,y:bottom},toolbar.model.getZoom());var rect=new Rectangle(leftTop.x/1e16,rightbottom.x/1e16,leftTop.y/1e16,rightbottom.y/1e16);this.removeZoomBox(this.zoomBox);this.zoomToExtent(toolbar.model,rect,this.mapDiv.parentNode,"zoomin");}
document.onselectstart=function(){return false};this.coord=null;this.newCoord=null;Event.stop(e);},removeZoomBox:function(zoom){if(!zoom)return;zoom.parentNode.removeChild(zoom);zoom=null;},clickHandler:function(e,movel){Event.stop(e);},dblClickHandler:function(e,movel){Event.stop(e);}});ZoomoutTool=Class.create();ZoomoutTool.prototype=Object.extend(new Abstract.Tool(),{cursorStyle:'url("images/zoomout.cur")',selected:false,alt:'拉框缩小',mouseDownHandler:function(e,toolbar){this.mapDiv=toolbar.mapDiv;this.mouseDownPixel=Util.getMouseRelativePixel(e,this.mapDiv);this.zoomBox=Util.createDiv('zoomBox',this.mouseDownPixel.x,this.mouseDownPixel.y,null,null,null,"absolute","1px solid red");this.zoomBox.style.backgroundColor="white";this.zoomBox.style.filter="alpha(opacity=50)";this.zoomBox.style.opacity="0.50";this.zoomBox.style.fontSize="1px";this.mapDiv.appendChild(this.zoomBox);Event.stop(e);},mouseMoveHandler:function(e,toolbar){this.mapDiv=toolbar.mapDiv;this.mouseMovePixel=Util.getMouseRelativePixel(e,this.mapDiv);if(this.mouseDownPixel){var deltaX=Math.abs(this.mouseDownPixel.x-this.mouseMovePixel.x);var deltaY=Math.abs(this.mouseDownPixel.y-this.mouseMovePixel.y);this.zoomBox.style.width=Math.max(1,deltaX)+"px";this.zoomBox.style.height=Math.max(1,deltaY)+"px";if(this.mouseMovePixel.x<this.mouseDownPixel.x)
this.zoomBox.style.left=this.mouseMovePixel.x+"px";if(this.mouseMovePixel.y<this.mouseDownPixel.y)
this.zoomBox.style.top=this.mouseMovePixel.y+"px";}
Event.stop(e);},mouseUpHandler:function(e,toolbar){if(this.mouseDownPixel&&this.mouseMovePixel){var top=Math.min(this.mouseDownPixel.y,this.mouseMovePixel.y);var bottom=Math.max(this.mouseDownPixel.y,this.mouseMovePixel.y);var left=Math.min(this.mouseDownPixel.x,this.mouseMovePixel.x);var right=Math.max(this.mouseDownPixel.x,this.mouseMovePixel.x);var leftTop=Util.getCoordinateByPixel({x:left,y:top},toolbar.model.getZoom());var rightbottom=Util.getCoordinateByPixel({x:right,y:bottom},toolbar.model.getZoom());var rect=new Rectangle(leftTop.x/1e16,rightbottom.x/1e16,leftTop.y/1e16,rightbottom.y/1e16);this.removeZoomBox(this.zoomBox);this.zoomToExtent(toolbar.model,rect,this.mapDiv.parentNode,"zoomout");}
document.onselectstart=function(){return false};this.coord=null;this.newCoord=null;Event.stop(e);},removeZoomBox:function(zoom){if(!zoom)return;this.mapDiv.removeChild(zoom);zoom=null;},clickHandler:function(e,movel){Event.stop(e);},dblClickHandler:function(e,movel){Event.stop(e);}});MeasureTool=Class.create();MeasureTool.prototype=Object.extend(new Abstract.Tool(),{isDrag:false,selected:false,cursorStyle:'url("images/mea.cur")',alt:'测量距离',measure:new Array(),mouseDownHandler:function(e,toolbar){if(!this.lineDiv){this.lineDiv=Util.createDiv('lineDiv');}
this.mapDiv=toolbar.mapDiv;this.mapDiv.appendChild(this.lineDiv);this.mouseDownPixel=Util.getMouseRelativePixel(e,this.mapDiv);if(!this.isDrag){this.isDrag=true;}
this.lastX=this.mouseDownPixel.x;this.lastY=this.mouseDownPixel.y;this.line='<v:line from="'+this.lastX+','+this.lastY+'" to="'+this.mouseDownPixel.x+','+this.mouseDownPixel.y+'" strokecolor="red" strokeweight="2pt" style="position:absolute;left:-3px;top:-3px;"></v:line>';this.vLine=document.createElement(this.line);this.lineDiv.appendChild(this.vLine);var coord=Util.getCoordinateByPixel(this.mouseDownPixel,toolbar.model.getZoom());this.measure.push(new Point(coord.x/1e16,coord.y/1e16));Event.stop(e);},mouseMoveHandler:function(e,toolbar){if(!this.isDrag){return;}
this.mouseMovePixel=Util.getMouseRelativePixel(e,this.mapDiv);this.vLine.to=this.mouseMovePixel.x+","+this.mouseMovePixel.y;Event.stop(e);},dblClickHandler:function(e,toolbar){if(!this.isDrag||!this.lineDiv)
return;this.lineDiv.innerHTML="";this.mapDiv.removeChild(this.lineDiv);var pline=new Polyline("measure",this.measure,"blue",2,null,null,null,null,true);pline.setToMap(toolbar.mapDiv,toolbar.model);this.measure=new Array();this.isDrag=false;var len=pline.getLength();var unit='';if(len!=null&&len.toString().indexOf(".")){var i=len.toString().indexOf(".");if(i<4){unit="米";len=Number(len.toString().substring(0,i+3));}
else{len=len/1000;i=len.toString().indexOf(".");len=Number(len.toString().substring(0,i+4));unit="千米";}}
var infoCoord=Util.getMouseRelativePixel(e,this.mapDiv);var mCoord=Util.getMousePixel(e);this.CreateMeasureInfo(toolbar.model.getId(),infoCoord,mCoord,"<br>本次总测量距离：<br>"+len+unit);Event.stop(e);},CreateMeasureInfo:function(modelId,infoCoord,mCoord,result){var div=$("measureResultDiv");var resultDivId=Util.createUniqueID("measureResult_");if(!div){var mapDiv=$("map_"+modelId);this.measureResult=document.createElement("div");this.measureResult.id=Util.createUniqueID("measureResultDiv_");this.measureResult.onselect=null;this.measureResult.style.position="absolute";this.measureResult.style.background="#FFFFFF";this.measureResult.style.border="1px solid #999999";this.measureResult.style.fontSize="12px";this.measureResult.style.padding="1px";this.measureResult.innerHTML='<div style="background:#EEEEEE;"><table style="width:150px;"><tr><td align=left>测量结果</td><td align=right><img onmousedown="hideWindown(event, \''+this.measureResult.id+'\')" src="'+ImageBaseDir+'infowindow_close.gif"></td></tr></table></div>';this.measureResult.innerHTML+='<div id="'+resultDivId+'" align="center" style="padding:2px;height:50px;width:150px;z-index:10"></div>';map.getVMLDiv().appendChild(this.measureResult);}
this.measureResult.style.zIndex=11;var mw=map.getMapWidth();if(mCoord.x+150>mw){infoCoord.x=infoCoord.x-150;}
var mh=map.getMapHeight();if(mCoord.y+60>mh){infoCoord.y=infoCoord.y-60;}
this.measureResult.style.left=infoCoord.x+"px";this.measureResult.style.top=infoCoord.y+"px";$(resultDivId).innerHTML=result;this.measureResult.style.display="";},clickHandler:function(e,model){Event.stop(e);},mouseUpHandler:function(e,model){Event.stop(e);}});LabelTool=Class.create();LabelTool.prototype=Object.extend(new Abstract.Tool(),{isDrag:false,selected:false,currentLabel:new Array(),cursorStyle:'url("images/mea.cur")',alt:'标签定位',barClickHandler:function(e)
{var elm=Event.element(e);if(elm.childNodes.length>0)return;this.clearCurrentToolStatus();var tool=this.tools[Event.element(e).parentNode.id];tool.div.childNodes[0].src=tool.img_down;if(!tool.selected){tool.selected=true;this.currentTool=tool;this.mapDiv.style.cursor=tool.cursorStyle;}
if(typeof(CBPControl)!="undefined")
{var cbpcontent='<div id="LABELDIV" name="LABELDIV" style="width:400px">';cbpcontent+='<table style="width:100%">';cbpcontent+='<tr>';cbpcontent+='<td style="width:20%;text-align:right;font-size:12px">';cbpcontent+='标签列表：';cbpcontent+='</td>';cbpcontent+='<td id="LABELTD" name="LABELTD" style="width:60%;font-size:12px">';cbpcontent+='<select style="width:100%;font-size:12px" id="SELELABELID" onchange="LabelTool.prototype.getLabelInfo(this);">';cbpcontent+='<option value="">请选择……</option>';cbpcontent+='</select>';cbpcontent+='</td>';cbpcontent+='<td>';cbpcontent+='<input style="font-size:12px" type="button" id="LblManage" value="定义标签" onclick="LabelTool.prototype.labelMaintenance();" readOnly="true"/>';cbpcontent+='</td>';cbpcontent+='</tr>';cbpcontent+='</table>';cbpcontent+='</div>';CBPControl.addHtml(cbpcontent);LabelTool.prototype.getLabels();CBPControl.doShowExpand();CBPControl.panDiv.childNodes[0].src=ImageBaseDir+"panel/arrow1.gif";}
Event.stop(e);},getLabels:function()
{var url="webgis.MapLabel.getLabels.d";url=encodeURI(url);new Ajax.Request(url,{method:'post',parameters:'',onComplete:function(xmlHttp)
{var text=xmlHttp.responseText;if(text!="null")
{var xmlDoc=xmlHttp.responseXML;LabelTool.prototype.showLabelList(xmlDoc);}}});},showLabelList:function(xmlDoc)
{var lbls=xmlDoc.getElementsByTagName("lblinfo");if(lbls!=null&&lbls.length>0)
{var lbltd=document.getElementById("LABELTD");var lblsel="<select style=\"width:100%;font-size:12px\" id=\"SELELABELID\" onchange=\"LabelTool.prototype.getLabelInfo(this);\">";lblsel+="<option value=\"\">请选择...</option>";lblsel+="</select>";lbltd.innerHTML=lblsel;var sel=document.getElementById("SELELABELID");for(var i=0;i<lbls.length;i++)
{var lbl=lbls[i].childNodes;var id=lbl[0].text;var title=lbl[1].text;var tempOption=document.createElement("OPTION");sel.options.add(tempOption);tempOption.innerText=title;tempOption.value=id;}
return null;}
return null;},getLabelInfo:function(obj)
{var index=obj.options.selectedIndex;if(index==0)
{return null;}
else
{var id=obj.options[index].value;var url="webgis.MapLabel.getLabelInfoById.d";var params="?labelid="+id;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var text=xmlHttp.responseText;if(text!="null")
{var xmlDoc=xmlHttp.responseXML;LabelTool.prototype.showSingleLabel(xmlDoc);}}});return null;}},showSingleLabel:function(xmlDoc)
{var lblinfo=xmlDoc.getElementsByTagName("lblinfo")[0].childNodes;var lblx=lblinfo[1].text;var lbly=lblinfo[2].text;var lbllevel=lblinfo[3].text;var ctX=parseFloat(lblx)*1e16;var ctY=parseFloat(lbly)*1e16;var ctPt=new Point(ctX,ctY);map.moveToCenter(ctPt,parseFloat(lbllevel));},labelMaintenance:function()
{var objLabel=document.getElementById("LablePanelDiv");var objImage=document.getElementById("LableImageDiv");if(objLabel){objLabel.parentNode.removeChild(objLabel);}
if(objImage){objImage.parentNode.removeChild(objImage);}
var labelPanel=new LabelPanel($('map'));}});function hideWindown(e,id){var obj=$(id);obj.style.display="none";Event.stop(e);}
Abstract.ExtTool=function(){};Abstract.ExtTool.prototype={initialize:function(id){this.toolType="ExtTool";this.id=id;this.MARK_FLAG=false;this.mapDiv=map.getMapDiv();this.vmlDiv=map.getVMLDiv();this.registerEventToMap();},registerEventToMap:function(){this.mapDiv=map.getMapDiv();Event.observe(this.mapDiv,"mousedown",this.mouseDownHandler.bindAsEventListener(this));Event.observe(this.mapDiv,"mousemove",this.mouseMoveHandler.bindAsEventListener(this));Event.observe(this.mapDiv,"mouseup",this.mouseUpHandler.bindAsEventListener(this));Event.observe(this.mapDiv,"dblclick",this.dblClickHandler.bindAsEventListener(this));Event.observe(this.mapDiv,"click",this.clickHandler.bindAsEventListener(this));},mouseDownHandler:function(e){},mouseMoveHandler:function(e){},mouseUpHandler:function(e){},clickHandler:function(e){Event.stop(e);},dblClickHandler:function(e){},extClickHandler:function(e){map.getMapDiv().style.cursor=this.cursorStyle;Event.stop(e);},toPan:function(bPan){toolbar.clearCurrentToolStatus();var tool=toolbar.tools['pan'];tool.div.childNodes[0].src=tool.img_down;tool.selected=bPan;toolbar.currentTool=tool;this.mapDiv.style.cursor=tool.cursorStyle;}};function testtt(){alert("test");}
ExtMeasureTool=Class.create();ExtMeasureTool.prototype=Object.extend(new Abstract.ExtTool(),{isDrag:false,selected:false,cursorStyle:'url("images/mea.cur")',alt:'画多义线',measure:new Array(),mouseDownHandler:function(e){if(this.MARK_FLAG){this.mapDiv=map.getMapDiv();this.mouseDownPixel=Util.getMouseRelativePixel(e,this.mapDiv);if(!this.isDrag){this.isDrag=true;}
this.lastX=this.mouseDownPixel.x;this.lastY=this.mouseDownPixel.y;this.nowName="virLine";this.line='<v:line to="0,0" strokecolor="red" strokeweight="5pt" style="position:absolute;" onmousedown="testtt()"></v:line>';this.vLine=document.createElement(this.line);this.vLine.from=this.lastX+","+this.lastY;this.vLine.to=this.mouseDownPixel.x+","+this.mouseDownPixel.y;this.vLine.name=this.nowName;this.mapDiv.appendChild(this.vLine);var coord=Util.getCoordinateByPixel(this.mouseDownPixel,map.getCurrentZoom());this.measure.push(new Point(coord.x/1e16,coord.y/1e16));}
Event.stop(e);},clickwwjHandler:function(e){alert("wwj");},mouseMoveHandler:function(e){if(this.MARK_FLAG){if(!this.isDrag){return;}
this.mouseMovePixel=Util.getMouseRelativePixel(e,this.mapDiv);if(this.mouseMovePixel.x>this.lastX&&this.mouseMovePixel.y>this.lastY){this.vLine.style.left="-3px";this.vLine.style.top="-3px";}
else if(this.mouseMovePixel.x>this.lastX&&this.mouseMovePixel.y<this.lastY){this.vLine.style.left="-1px";this.vLine.style.top="1px";}
else if(this.mouseMovePixel.x<this.lastX&&this.mouseMovePixel.y<this.lastY){this.vLine.style.left="1px";this.vLine.style.top="1px";}
else if(this.mouseMovePixel.x<this.lastX&&this.mouseMovePixel.y>this.lastY){this.vLine.style.left="1px";this.vLine.style.top="-1px";}
this.vLine.to=this.mouseMovePixel.x+","+this.mouseMovePixel.y;}
Event.stop(e);},dblClickHandler:function(e){if(this.MARK_FLAG){if(!this.isDrag){return;}
this.toPan(false);var virLine=document.getElementsByName(this.nowName);for(var k=0;k<virLine.length;k++){this.mapDiv.removeChild(virLine[k]);}
var pline=new Polyline("measure",this.measure,"blue",1,null,null,null,null,true);var vvLine=pline.setToMap(this.vmlDiv,map.getMapModel());Event.observe(vvLine,"click",this.clickwwjHandler.bindAsEventListener(vvLine));this.measure=new Array();this.isDrag=false;this.MARK_FLAG=false;this.toPan(true);}
Event.stop(e);}});
Abstract.Command=function(){}
Abstract.Command.prototype={initialize:function(id,img1,img2,img3,pos,left,top,width,height){this.toolType="Command";this.id=id;this.img_normal=img1;this.img_over=img2;this.img_down=img3;this.position=pos;this.left=parseInt(left);this.top=parseInt(top);this.width=parseInt(width);this.height=parseInt(height);this.div=Util.createDiv(this.id,this.left,this.top,this.width,this.height,this.img_normal,this.position,'0px solid #ccc');this.div.style.cursor="pointer";},cmdClickHandler:function(e){if(Event.element(e).childNodes.length>0)
return;this.clearCurrentToolStatus();var cmd=this.tools[Event.element(e).parentNode.id];cmd.div.childNodes[0].src=cmd.img_down;if(!cmd.selected)
cmd.selected=true;this.currentTool=this.defaultTool;this.currentTool.div.childNodes[0].src=this.currentTool.img_normal;this.mapDiv.style.cursor=this.currentTool.cursorStyle;cmd.cmd_clickHandler(cmd,this.model,this.mapDiv);Event.stop(e);},cmdMouseOverHandler:function(e){var elm=Event.element(e)
if(elm.childNodes.length>0)
return;var cmd=this.tools[elm.parentNode.id];if(cmd.selected==true)
return;elm.alt=cmd.alt;elm.src=cmd.img_over;Event.stop(e);},cmdMouseOutHandler:function(e){var elm=Event.element(e)
if(elm.childNodes.length>0)
return;var cmd=this.tools[elm.parentNode.id];if(cmd.selected==true)
return;elm.src=cmd.img_normal;Event.stop(e);},clearOrgDiv:function(container,index){var nodes=container.childNodes;for(var i=0;i<nodes.length;i++){if(nodes[i].id.indexOf('search'+index+'_')>-1){container.removeChild(nodes[i]);}}},registerEvent:function(source,param){Event.observe(source,param.split(',')[0],eval('this.'+param.split(',')[0]).bindAsEventListener(this));Event.observe(source,param.split(',')[1],eval('this.'+param.split(',')[1]).bindAsEventListener(this));Event.observe(source,param.split(',')[2],eval('this.'+param.split(',')[2]).bindAsEventListener(this));},mousedown:function(e){if(Event.element(e).childNodes.length==0)
return;if(!this.dragged)
this.dragged=true;this.elm=Event.element(e);this.orgPixelX=Util.getValueOfNoPX(this.elm.parentNode.style.left);this.orgPixelY=Util.getValueOfNoPX(this.elm.parentNode.style.top);this.elm.style.cursor='move';this.orgMousePixel=Util.getMousePixel(e);if(this.elm.setCapture){this.elm.setCapture();}
else
if(window.captureEvents){window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);}},mousemove:function(e){if(!this.dragged)
return;if(!Event.element(e))
return;this.newMousePixel=Util.getMousePixel(e);var deltaX=this.newMousePixel.x-this.orgMousePixel.x;var deltaY=this.newMousePixel.y-this.orgMousePixel.y;this.elm.parentNode.style.left=(this.orgPixelX+deltaX)+"px";this.elm.parentNode.style.top=(this.orgPixelY+deltaY)+"px";},mouseup:function(e){if(!this.elm)
return;if(this.elm.releaseCapture)
this.elm.releaseCapture();else
if(window.captureEvents)
window.captureEvents(Event.MOUSEMOVE|Event.MOUSEUP);document.onmousemove=null;document.onmouseup=null;this.dragged=false;this.elm.style.cursor='';}};FullCmd=Class.create();FullCmd.prototype=Object.extend(new Abstract.Command(),{alt:'全图显示',selected:false,cmd_clickHandler:function(cmd,model,mapDiv){model.reset(mapDiv,$('sliderbar_'+model.getId()).parentNode);}});ClearCmd=Class.create();ClearCmd.prototype=Object.extend(new Abstract.Command(),{alt:'清除操作痕迹',selected:false,cmd_clickHandler:function(cmd,model,mapDiv){map.getVMLDiv().innerHTML="";}});PrevCmd=Class.create();PrevCmd.prototype=Object.extend(new Abstract.Command(),{alt:'移到上一屏',selected:false,cmd_clickHandler:function(cmd,model,mapDiv){if(model.curIndex==-1)
model.curIndex=model.traceIndex-1;if(model.curIndex>0&&model.curIndex<=model.traceIndex-1){var obj=model.traces[--model.curIndex];model.setViewCenterCoord(obj.coord);model.setZoom(new Zoom(obj.level));model.controls[mapDiv.id].paint(model,false);model.controls[model.ovId].paint(model);$('sliderbar_'+model.getId()).parentNode.style.top=((MaxZoomLevel-obj.level)*12+6)+"px";}}});NextCmd=Class.create();NextCmd.prototype=Object.extend(new Abstract.Command(),{alt:'移到下一屏',selected:false,cmd_clickHandler:function(cmd,model,mapDiv){if(model.curIndex==-1)
model.curIndex=model.traceIndex-1;if(model.curIndex>=0&&model.curIndex<model.traceIndex-1){var obj=model.traces[++model.curIndex];model.setViewCenterCoord(obj.coord);model.setZoom(new Zoom(obj.level));model.controls[mapDiv.id].paint(model,false);model.controls[model.ovId].paint(model);$('sliderbar_'+model.getId()).parentNode.style.top=((MaxZoomLevel-obj.level)*12+6)+"px";}}});SearchCmd=Class.create();SearchCmd.prototype=Object.extend(new Abstract.Command(),{alt:'地图检索',selected:false,cmd_clickHandler:function(cmd,model,mapDiv){var objSearch=document.getElementById("SearchPanelDiv");var objImage=document.getElementById("ImageButtonDiv");if(objSearch){objSearch.parentNode.removeChild(objSearch);}
if(objImage){objImage.parentNode.removeChild(objImage);}
var searchPanel=new SearchPanel($('map'));}});LocateCmd=Class.create();LocateCmd.prototype=Object.extend(new Abstract.Command(),{alt:'辖区定位',selected:false,cmd_clickHandler:function(cmd,model,mapDiv){this.clearOrgDiv(mapDiv.parentNode,2);this.areaLocate(mapDiv,model);},areaLocate:function(mapDiv,model){var left=Util.getValueOfNoPX(mapDiv.parentNode.style.width)-220;this.areaDiv=Util.createDiv(Util.createUniqueID('search2_'),left,10,220,300,null,"absolute","1px solid blue");this.areaDiv.style.backgroundColor="white";this.areaDiv.style.filter="alpha(opacity=80)";this.areaDiv.style.opacity="0.80";this.areaDiv.style.fontSize="1px";this.areaDiv.style.zIndex=10000;this.areaDiv.innerHTML='<div align="right" style="background:blue;padding:1px;cursor:default"><img onclick="hideInfoWindown(event, \''+this.areaDiv.id+'\')" src="'+ImageBaseDir+'infowindow_close.gif"></div>';this.areaDiv.innerHTML+='<iframe id="searchFrame" name="searchFrame" style="width:100%; height:400px;" src="../point.jsf?flag=1" scrolling="no" frameborder="0"></iframe>';this.registerEvent(this.areaDiv.childNodes[0],"mousedown,mousemove,mouseup");mapDiv.parentNode.appendChild(this.areaDiv);}});
CPanelItem=Class.create();CPanelItem.prototype={initialize:function(id,imgsrcD,imgsrcA,height){this.id=id;this.name=name;this.imgsrcD=imgsrcD;this.imgsrcA=imgsrcA;this.height=height;},create:function(){this.item=Util.createDiv(this.id);this.item.align="center";var html="<img id='"+this.id+"' src='"+this.imgsrcD+"' align='middle' height='"+this.height+"' width='15' />";this.item.innerHTML=html;this.item.style.cursor="pointer";},activeItem:function(){var html="<img id='"+this.id+"' src='"+this.imgsrcA+"' align='middle' height='"+this.height+"' width='15' />";this.item.innerHTML=html;},deActiveItem:function(){var html="<img id='"+this.id+"' src='"+this.imgsrcD+"' align='middle' height='"+this.height+"' width='15' />";this.item.innerHTML=html;},getItem:function(){return this.item;},getId:function(){return this.id;}}
CPanelContent=Class.create();CPanelContent.prototype={initialize:function(id,bgcolor,text){this.id=id;this.bgcolor=bgcolor;this.text=text;},create:function(){this.contentDiv=Util.createDiv(this.id);this.contentDiv.innerHTML=this.text;this.contentDiv.style.backgroundColor=this.bgcolor;this.contentDiv.style.width="100%";this.contentDiv.style.height="100%";},getContent:function(){return this.contentDiv;}}
SearchPanel=Class.create();SearchPanel.prototype={wholeDiv:null,initialize:function(container)
{this.container=container;wholeDiv=this.createWholeDiv(container);this.initFill(wholeDiv);this.currentTimeoutAction=null;},createWholeDiv:function(obj)
{var tempdiv=Util.createDiv('SearchPanelDiv');tempdiv.style.position="absolute";tempdiv.style.top=obj.style.pixelTop+24;tempdiv.style.left=obj.style.pixelLeft;this.divleft=tempdiv.style.left;tempdiv.style.width=396;tempdiv.style.height=254;tempdiv.style.backgroundColor="#0A9AF3";tempdiv.style.zIndex=navControl.navToolDiv.style.zIndex+1;obj.appendChild(tempdiv);var imgdiv=Util.createDiv('ImageButtonDiv');imgdiv.style.position="absolute";imgdiv.style.top=obj.style.pixelTop+24;imgdiv.style.left=obj.style.pixelLeft;this.divleft=imgdiv.style.left;imgdiv.style.zIndex=navControl.navToolDiv.style.zIndex+1;var image=Util.createImg("ps",0,0,12,12,"webgis/images/button/btnShow.gif");image.title="显示检索面板";image.style.cursor="pointer";Event.observe(image,"click",showSerachDiv.bindAsEventListener(image));imgdiv.appendChild(image);imgdiv.style.display="none";obj.appendChild(imgdiv);var timact=null;function showSerachDiv()
{tempdiv.style.display="";imgdiv.style.display="none";clearTimeout(timact);if(tempdiv.style.pixelLeft<obj.style.pixelLeft-5)
{tempdiv.style.pixelLeft+=10;timact=setTimeout(showSerachDiv,10);}}
return tempdiv;},hideSerachDiv:function()
{var objSearch=document.getElementById("SearchPanelDiv");var objImage=document.getElementById("ImageButtonDiv");objSearch.style.display="none";objImage.style.display="";},closeSerachDiv:function()
{var objLabel=document.getElementById("SearchPanelDiv");var objImage=document.getElementById("ImageButtonDiv");if(objLabel){objLabel.parentNode.removeChild(objLabel);}
if(objImage){objImage.parentNode.removeChild(objImage);}},initFill:function(obj)
{var content='<div align="center" style="border:1px solid #97BECE;width:100%">\n';content+='<table style="width:100%">\n';content+='<td style="width:40%">\n';content+='<input style="width:100%;font-size:12px" type="text" id="SEARCHKEY" name="SEARCHKEY" value="" maxlength="10" onkeyup="SearchPanel.prototype.dotxtlist(this);"/>\n';content+='</td>\n';content+='<td style="width:40%">\n';content+='<div>\n';content+='<table style="width:100%">\n';content+='<tr>\n';content+='<td style="width:10%">\n';content+='<input style="width:100%" type="radio" id="CHECKTYPE" name="CHECKTYPE" checked onclick="SearchPanel.prototype.showGeneral()"/>\n';content+='</td>\n';content+='<td style="width:30%;font-size:12px;text-align:left">\n';content+='通用检索\n';content+='</td>\n';content+='<td style="width:10%">\n';content+='<input style="width:100%" type="radio" id="CHECKTYPE" name="CHECKTYPE" onclick="SearchPanel.prototype.showProfessional()"/>\n';content+='</td>\n'
content+='<td style="width:30%;font-size:12px;text-align:left">\n';content+='分类检索\n';content+='</td>\n';content+='</tr>\n';content+='</table>\n';content+='</div>\n';content+='</td>\n';content+='<td style="width:18%">\n';content+='<input type="image" style="width:47;height:17" src="webgis/images/button/btnQuery.gif" onclick="SearchPanel.prototype.search()" />\n';content+='<input type="hidden" id="sql" name="sql" value="" />\n';content+='<input type="hidden" id="gsql" name="gsql" value="" />\n';content+='<input type="hidden" id="searchtype" name="searchtype" value="g"/>\n';content+='</td>\n';content+='<td style="width:2%;" valign="top" align="right">\n';content+='<input type="image" style="width:12;height:12" src="webgis/images/button/btnClose.gif" title="关闭检索面板" onclick="SearchPanel.prototype.closeSerachDiv()" />\n';content+='<input type="image" style="width:12;height:12" src="webgis/images/button/btnHide.gif" title="隐藏检索面板" onclick="SearchPanel.prototype.hideSerachDiv()" />\n';content+='</td>\n';content+='</tr>\n';content+='</table>\n';content+='</div>\n';content+='<div id="profdiv" name="profdiv" style="width:100%;height:220px;display:none;background-color:white">\n';content+='<div id="ntdiv" name="ntdiv" style="border:1px solid #97BECE;float:left;width:30%;height:100%;overflow:scroll"></div>\n';content+='<div style="border:1px solid #97BECE;float:right;width:70%;height:100%">\n';content+='<div id="searchResult" name="searchResult"></div>\n';content+='<div id="pageData" name="pageData"></div>\n';content+='<div id="pageNav" name="pageNav"></div>\n';content+='</div>\n';content+='</div>\n';content+='<div id="generaldiv" name="generaldiv" align="center" style="width:100%;height:220px;background-color:white">\n';content+='<div style="border:1px solid #97BECE;float:right;width:100%;height:100%">\n';content+='<div id="gsearchResult" name="gsearchResult"></div>\n';content+='<div id="gpageData" name="gpageData"></div>\n';content+='<div id="gpageNav" name="gpageNav"></div>\n';content+='</div>\n';content+='</div>\n';obj.innerHTML=content;var url="webgis.MapSearch.getSearchTypes.d";url=encodeURI(url);new Ajax.Request(url,{method:'post',parameters:'',onComplete:function(xmlHttp)
{var xmlDoc=xmlHttp.responseXML;if(xmlDoc)
{var types=xmlDoc.getElementsByTagName("typeinfo");if(types!=null&&types.length>0)
{var ntliststr="<table style=\"width:100%\">";for(var i=0;i<types.length;i++)
{var type=types[i].childNodes;var ntk=type[0].text;var title=type[1].text;ntliststr+="<tr style=\"width:100%;heigh:18px;font-size:12px\"><td valign=top>";ntliststr+="<input type=\"checkbox\" id=\"NAMENTYPENKEY\" name=\"NAMENTYPENKEY\" value=\""+ntk+"\" />";ntliststr+=title;ntliststr+="</td></tr>";}
ntliststr+="</table>";document.getElementById("ntdiv").innerHTML=ntliststr;}}}});},dotxtlist:function(obj)
{obj.value=obj.value.replace(/[^\u4e00-\u9fa5|^\a-zA-Z|]|\||\^|/g,'');clearTimeout(this.currentTimeoutAction);if(document.getElementById("searchtype").value=="g")
{this.currentTimeoutAction=setTimeout(this.showtxtlist,500);}},showtxtlist:function()
{var obj=document.getElementById("SEARCHKEY");var sdivs=wholeDiv.getClientRects();var currenttxt=Util.trim(obj.value);if(currenttxt!="")
{var tempdiv=document.getElementById("preDIV");if(tempdiv)
{wholeDiv.removeChild(tempdiv);}
var rects=obj.getClientRects();tempdiv=document.createElement("<DIV id=\"preDIV\" name=\"preDIV\">");tempdiv.style.position="absolute";tempdiv.style.top=(rects[0].bottom-sdivs[0].top)+"px";tempdiv.style.left=(rects[0].left-sdivs[0].left)+"px";tempdiv.style.border="1px solid #97BECE";tempdiv.style.backgroundColor="white";tempdiv.style.width=(rects[0].right-rects[0].left)+"px";tempdiv.style.zIndex=wholeDiv.style.zIndex+1;var url="webgis.MapSearch.preSearch.d";var params="?currentkey="+currenttxt;if(Util.isLetter(currenttxt))
{params+="&keytype=en";}
else if(Util.isChinese(currenttxt))
{params+="&keytype=ch";}
params+="&numofrows=8";url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var xmldoc=xmlHttp.responseXML;if(xmldoc)
{SearchPanel.prototype.fillDropdownDiv(tempdiv,xmldoc);}}});}
else
{var tempdiv=document.getElementById("preDIV");if(tempdiv)
{wholeDiv.removeChild(tempdiv);}}},fillDropdownDiv:function(obj,xmldoc)
{var prechoices=xmldoc.getElementsByTagName("tempPre");if(prechoices!=null&&prechoices.length>0)
{var ntliststr="<table style=\"width:100%\">";for(var i=0;i<prechoices.length;i++)
{var tempchoice=prechoices[i].childNodes;var cvalue=tempchoice[0].text;ntliststr+="<tr style=\"width:100%;font-size:12px\" onmouseover=\"SearchPanel.prototype.mouseover(this,'#609ca0')\" onmouseout=\"SearchPanel.prototype.mouseout(this,'#5f9ea0')\" onclick=\"SearchPanel.prototype.dochoose('"+cvalue+"')\"><td>";ntliststr+=cvalue;ntliststr+="</td></tr>";}
ntliststr+="<tr style=\"width:100%;font-size:12px;text-align:right\"><td><a href=\"javascript:SearchPanel.prototype.closeDList()\">关闭</a></td></tr>"
ntliststr+="</table>";obj.innerHTML=ntliststr;}
wholeDiv.appendChild(obj);},dochoose:function(str)
{document.getElementById("SEARCHKEY").value=str;this.closeDList();},closeDList:function()
{var tempdiv=document.getElementById("preDIV");if(tempdiv)
{wholeDiv.removeChild(tempdiv);}},mouseover:function(obj,color)
{obj.style.cursor="hand";if(obj.bgColor!=color&&obj.bgColor!="#9ece6e")
{obj.bgColor="#609ca0";}},mouseout:function(obj,color)
{if(obj.bgColor!="#9ece6e")
{obj.bgColor="#FFFFFF";}},search:function()
{var searchtype=document.getElementById("searchtype").value;if(searchtype=="p")
{this.doProfSearch();}
else
{this.doGeneralSearch();}},doGeneralSearch:function()
{var searchkey=document.getElementById("SEARCHKEY").value;var url="webgis.MapSearch.genSql.d";var params="?searchkey="+searchkey;params+="&searchtype="+document.getElementById("searchtype").value;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var sql=xmlHttp.responseText;PageCtrl.initPage("gsearchResult","gpageData","gpageNav",convertSql(sql),"SearchPanel.prototype.showGList",10);}});},showGList:function(xmlDoc)
{var tstr="<table id=\"tleList\" width=100% cellSpacing=0 cellPadding=0 style=\"border:1px solid #97BECE;\">";tstr+="<tr bordercolor=\"black\">";tstr+="<th style=\"align:center;font-size:12px;width:100%;background-color:#b4c1e4\">地点名称</th>";tstr+="</tr>";var results=xmlDoc.getElementsByTagName("row");for(var i=0;i<results.length;i++)
{var rowResult=results[i].childNodes;var locName=rowResult[0].firstChild;if(locName!=null)
{locName=locName.nodeValue;}
var longitude=rowResult[1].firstChild;if(longitude!=null)
{longitude=longitude.nodeValue;}
var latitude=rowResult[2].firstChild;if(latitude!=null)
{latitude=latitude.nodeValue;}
tstr+="<tr style=\"font-size:12px\" onmouseover=\"SearchPanel.prototype.mouseover(this,'#609ca0')\" onmouseout=\"SearchPanel.prototype.mouseout(this,'#5f9ea0')\">";tstr+="<td style=\"border-left: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;padding: 1px;\" align=\"center\" onclick=\"SearchPanel.prototype.doGGISshow(this,'#9ece6e','"+longitude+"','"+latitude+"');\">"+locName+"</td>";tstr+="</tr>";}
tstr+="</table>";document.getElementById("gpageData").innerHTML=tstr;},doGGISshow:function(obj,color,longitude,latitude)
{var currentLoc=obj.innerText;if(obj.bgColor!=color){obj.bgColor=color;}
var ctX=parseFloat(longitude)*1e16;var ctY=parseFloat(latitude)*1e16;var ctPt=new Point(ctX,ctY);var coord=new Coordinate(ctX,ctY);map.moveToCenter(ctPt,MaxZoomLevel);var spoint=Util.getScreenPixel(coord,map.getMapModel().getZoom());MapTips.prototype.showPopup(map.getVMLDiv(),currentLoc,"",spoint.x,spoint.y);},showGeneral:function()
{document.getElementById("profdiv").style.display="none";var obj=document.getElementById("generaldiv");if(obj.style.display=="none")
{obj.style.display="inline";}
document.getElementById("searchtype").value="g";},showProfessional:function()
{document.getElementById("generaldiv").style.display="none";var obj=document.getElementById("profdiv");if(obj.style.display=="none")
{obj.style.display="inline";}
document.getElementById("searchtype").value="p";},doProfSearch:function()
{var ntk=document.getElementsByName("NAMENTYPENKEY");var ntkstr="";for(var i=0;i<ntk.length;i++)
{if(ntk[i].checked)
{ntkstr+=ntk[i].value;ntkstr+=";";}}
ntkstr=ntkstr.substr(0,ntkstr.length-1);if(ntkstr=="")
{alert("请先选择搜索类型！");return false;}
var searchkey=Util.trim(document.getElementById("SEARCHKEY").value);if(searchkey=="")
{alert("请输入地点名称！");return false;}
var url="webgis.MapSearch.genSql.d";var params="?ntk="+ntkstr;params+="&searchkey="+searchkey;params+="&searchtype="+document.getElementById("searchtype").value;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var sql=xmlHttp.responseText;PageCtrl.initPage("searchResult","pageData","pageNav",convertSql(sql),"SearchPanel.prototype.showList",10,sdedatasource);}});},showList:function(xmlDoc)
{var tstr="<table id=\"tleList\" width=100% cellSpacing=0 cellPadding=0 style=\"border:1px solid #97BECE;\">";tstr+="<tr bordercolor=\"black\">";tstr+="<th style=\"align:center;font-size:12px;width:100%;background-color:#b4c1e4\">地点名称</th>";tstr+="</tr>";var results=xmlDoc.getElementsByTagName("row");for(var i=0;i<results.length;i++)
{var rowResult=results[i].childNodes;var locName=rowResult[0].firstChild;if(locName!=null)
{locName=locName.nodeValue;}
var locId=rowResult[1].firstChild;if(locId!=null)
{locId=locId.nodeValue;}
var layerName=rowResult[2].firstChild;if(layerName!=null)
{layerName=layerName.nodeValue;}
var layerType=rowResult[3].firstChild;if(layerType!=null)
{layerType=layerType.nodeValue;}
var layerKeyFld=rowResult[4].firstChild;if(layerKeyFld!=null)
{layerKeyFld=layerKeyFld.nodeValue;}
tstr+="<tr style=\"font-size:12px\" onmouseover=\"SearchPanel.prototype.mouseover(this,'#609ca0')\" onmouseout=\"SearchPanel.prototype.mouseout(this,'#5f9ea0')\">";tstr+="<td style=\"border-left: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;padding: 1px;\" align=\"center\"  onclick=\"SearchPanel.prototype.doGISshow(this,'#9ece6e','"+locId+"','"+layerType+"','"+layerName+"','"+layerKeyFld+"');\">"+locName+"</td>";tstr+="</tr>";}
tstr+="</table>";document.getElementById("pageData").innerHTML=tstr;},doGISshow:function(obj,color,id,type,layer,keyname)
{var currentLoc=obj.innerText;if(obj.bgColor!=color){obj.bgColor=color;}
var url="webgis.MapSearch.gISShow.d";var params="?layername="+layer;params+="&keyid="+id;params+="&layertype="+type;params+="&keyname="+keyname;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var result=xmlHttp.responseText;result=result.split(";");var zlvl=result[0];var ctX=parseFloat(result[1].split(",")[0])*1e16;var ctY=parseFloat(result[1].split(",")[1])*1e16;var ctPt=new Point(ctX,ctY);var llx=parseFloat(result[1].split(",")[0]);var lly=parseFloat(result[1].split(",")[1]);var coord=new Coordinate(ctX,ctY);map.moveToCenter(ctPt,zlvl);var spoint=Util.getScreenPixel(coord,map.getMapModel().getZoom());MapTips.prototype.showPopup(map.getVMLDiv(),currentLoc,"",spoint.x,spoint.y);}});}};
LabelPanel=Class.create();LabelPanel.prototype={actionName:null,currentLabel:null,initialize:function(container)
{this.container=container;this.labelDiv=this.createLabelDiv(container);this.initFill(this.labelDiv);this.xmlDoc=null;currentLabel=new Array();actionName="";},createLabelDiv:function(obj)
{var tempdiv=Util.createDiv('LablePanelDiv');tempdiv.style.position="absolute";tempdiv.style.top=obj.style.pixelTop+24;tempdiv.style.left=obj.style.pixelLeft;this.divleft=tempdiv.style.left;tempdiv.style.width=280;tempdiv.style.height=120;tempdiv.style.backgroundColor="#0A9AF3";tempdiv.style.zIndex=navControl.navToolDiv.style.zIndex+1;obj.appendChild(tempdiv);var imgdiv=Util.createDiv('LableImageDiv');imgdiv.style.position="absolute";imgdiv.style.top=obj.style.pixelTop+24;imgdiv.style.left=obj.style.pixelLeft;this.divleft=imgdiv.style.left;imgdiv.style.zIndex=navControl.navToolDiv.style.zIndex+1;var image=Util.createImg("ps",0,0,12,12,"webgis/images/button/btnShow.gif");image.title="显示标签面板";image.style.cursor="pointer";Event.observe(image,"click",showLabelDiv.bindAsEventListener(image));imgdiv.appendChild(image);imgdiv.style.display="none";obj.appendChild(imgdiv);var timact=null;function showLabelDiv()
{tempdiv.style.display="";imgdiv.style.display="none";clearTimeout(timact);if(tempdiv.style.pixelLeft<obj.style.pixelLeft-5)
{tempdiv.style.pixelLeft+=10;timact=setTimeout(showLabelDiv,10);}}
return tempdiv;},hideLabelDiv:function()
{var objLabel=document.getElementById("LablePanelDiv");var objImage=document.getElementById("LableImageDiv");objLabel.style.display="none";objImage.style.display="";},closeLabelDiv:function()
{var objLabel=document.getElementById("LablePanelDiv");var objImage=document.getElementById("LableImageDiv");if(objLabel){objLabel.parentNode.removeChild(objLabel);}
if(objImage){objImage.parentNode.removeChild(objImage);}},initFill:function(obj)
{var content='<div align="center" id="lblplacediv" style="border:1px solid #97BECE;width:100%">';content+='<input type="image" style="width:12;height:12" src="webgis/images/button/btnClose.gif" title="关闭标签面板" align="right" onclick="LabelPanel.prototype.closeLabelDiv();"/>';content+='<input type="image" style="width:12;height:12" src="webgis/images/button/btnHide.gif" title="隐藏标签面板" align="right" onclick="LabelPanel.prototype.hideLabelDiv();"/>';content+='<form id="lbform" name="lbform">';content+='<table>';content+='<tr height="20">';content+='<td colspan="4"></td>';content+='</tr>';content+='<tr>';content+='<td style="width:80x;text-align:right;font-size:12px">标签列表：</td>';content+='<td style="width:100px" id="LTD" name="LTD">';content+='<select style="width:100%;font-size:12px" id="LABELS">';content+='<option value="">请选择...</option>';content+='</select>';content+='</td>';content+='<td style="width:20px;text-align:right">';content+='<input style="font-size:12px" type="button" id="ADDLABEL" name="ADDLABEL" value="添加标签" onclick="LabelPanel.prototype.addlabel();" readOnly="true"/>';content+='</td>';content+='</tr>';content+='<tr>';content+='<td style="width:80px;text-align:right;font-size:12px">标 签 名：</td>';content+='<td style="width:100px">';content+='<input style="width:100%;font-size:12px" type="text" id="LABELTITLE" name="LABELTITLE" readonly="true" />';content+='</td>';content+='<td style="width:20px;text-align:right">';content+='<input style="font-size:12px" type="button" id="EDITLABEL" name="EDITLABEL" value="编辑标签" onclick="LabelPanel.prototype.editlabel();" disabled="true"/>';content+='</td>';content+='</tr>';content+='<tr>';content+='<td style="width:80px;text-align:right;font-size:12px">Ｘ 坐 标：</td>';content+='<td style="width:100px">';content+='<input style="width:100%;font-size:12px" type="text" id="LABELX" name="LABELX" readonly="true" />';content+='</td>';content+='<td style="width:20px;text-align:right">';content+='<input style="font-size:12px" type="button" id="DELETELABEL" name="DELETELABEL" value="删除标签" onclick="LabelPanel.prototype.deletelabel();" disabled="true"/>';content+='</td>';content+='</tr>';content+='<tr>';content+='<td style="width:80px;text-align:right;font-size:12px">Ｙ 坐 标：</td>';content+='<td style="width:100px">';content+='<input style="width:100%;font-size:12px" type="text" id="LABELY" name="LABELY" readonly="true" />';content+='</td>';content+='<td style="width:20px;text-align:right">';content+='<input type="hidden" id="LABELLEVEL" name="LABELLEVEL" value="" />';content+='<input style="font-size:12px" type="button" id="PRESERVELABEL" name="PRESERVELABEL" value="保存标签" onclick="LabelPanel.prototype.preservelabel();" disabled="true"/>';content+='</td>';content+='</tr>';content+='</table>';content+='</form>';content+='</div>';obj.innerHTML=content;LabelPanel.prototype.getLabels();},preservelabel:function()
{if(actionName=="adding")
{this.newlabel();}
if(actionName=="editing")
{this.updatelabel();}},newlabel:function()
{var labeltitle=Util.trim(document.getElementById("LABELTITLE").value);if(labeltitle=="")
{alert("请填写标签名！");return false;}
if(!Util.isNormalText(labeltitle))
{alert("标签名中含有特殊字符！");return false;}
var labelx=Util.trim(document.getElementById("LABELX").value);var labely=Util.trim(document.getElementById("LABELY").value);if(labelx==""||labely=="")
{alert("错误的标签位置！");return false;}
var labellevel=document.getElementById("LABELLEVEL").value;var url="webgis.MapLabel.newLabel.d";params="?labeltitle="+labeltitle;params+="&labelx="+labelx;params+="&labely="+labely;params+="&labellevel="+labellevel;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var text=xmlHttp.responseText;if(text=="true")
{document.getElementById("LABELTITLE").value="";document.getElementById("LABELX").value="";document.getElementById("LABELY").value="";document.getElementById("LABELLEVEL").value="";document.getElementById("PRESERVELABEL").disabled=true;document.getElementById("LABELTITLE").readOnly=true;alert("地图标签录入成功");LabelTool.prototype.getLabels();LabelPanel.prototype.getLabels();actionName="";}
else if(text=="false")
{alert("数据录入失败");}
else if(text=="dupe")
{alert("已有同名标签存在！请更改标签名！");}
else if(text=="error")
{alert("异常错误！数据录入失败！");}}});},updatelabel:function()
{var labeltitle=Util.trim(document.getElementById("LABELTITLE").value);if(labeltitle=="")
{alert("请填写标签名！");return false;}
if(!Util.isNormalText(labeltitle))
{alert("标签名中含有特殊字符！");return false;}
var labelx=Util.trim(document.getElementById("LABELX").value);var labely=Util.trim(document.getElementById("LABELY").value);if(labelx==""||labely=="")
{alert("错误的标签位置！");return false;}
var labellevel=document.getElementById("LABELLEVEL").value;var url="webgis.MapLabel.updateLabel.d";params="?labeltitle="+labeltitle;params+="&labelx="+labelx;params+="&labely="+labely;params+="&labellevel="+labellevel;params+="&labelid="+document.getElementById("LABELS").value;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var text=xmlHttp.responseText;if(text=="true")
{document.getElementById("LABELTITLE").value="";document.getElementById("LABELX").value="";document.getElementById("LABELY").value="";document.getElementById("LABELLEVEL").value="";document.getElementById("PRESERVELABEL").disabled=true;alert("地图标签更新成功");document.getElementById("LABELTITLE").readOnly=true;LabelTool.prototype.getLabels();LabelPanel.prototype.getLabels();actionName="";}
else if(text=="false")
{alert("数据更新失败");}
else if(text=="error")
{alert("异常错误！数据更新失败！");}}});},getLabels:function()
{var url="webgis.MapLabel.getLabels.d";url=encodeURI(url);new Ajax.Request(url,{method:'post',parameters:'',onComplete:function(xmlHttp)
{var text=xmlHttp.responseText;if(text!="null")
{var xmlDoc=xmlHttp.responseXML;LabelPanel.prototype.showLabelList(xmlDoc);}}});},showLabelList:function(xmlDoc)
{var lbls=xmlDoc.getElementsByTagName("lblinfo");if(lbls!=null&&lbls.length>0)
{var lbltd=document.getElementById("LTD");var lblsel="<select style=\"width:100%;font-size:12px\" id=\"LABELS\" name=\"LABELS\" onchange=\"LabelPanel.prototype.getLabelInfo(this);\">";lblsel+="<option value=\"\">请选择...</option>";lblsel+="</select>";lbltd.innerHTML=lblsel;var sel=document.getElementById("LABELS");for(var i=0;i<lbls.length;i++)
{var lbl=lbls[i].childNodes;var id=lbl[0].text;var title=lbl[1].text;var tempOption=document.createElement("OPTION");sel.options.add(tempOption);tempOption.innerText=title;tempOption.value=id;}
return null;}
return null;},getLabelInfo:function(obj)
{actionName="";document.getElementById("PRESERVELABEL").disabled=true;var index=obj.options.selectedIndex;if(index==0)
{document.getElementById("EDITLABEL").disabled=true;document.getElementById("DELETELABEL").disabled=true;document.getElementById("LABELTITLE").value="";document.getElementById("LABELX").value="";document.getElementById("LABELY").value="";document.getElementById("LABELLEVEL").value="";document.getElementById("LABELTITLE").readOnly=true;return null;}
else
{var id=obj.options[index].value;var url="webgis.MapLabel.getLabelInfoById.d";var params="?labelid="+id;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var text=xmlHttp.responseText;if(text!="null")
{document.getElementById("EDITLABEL").disabled=false;document.getElementById("DELETELABEL").disabled=false;var xmlDoc=xmlHttp.responseXML;LabelPanel.prototype.showSingleLabel(xmlDoc);}}});return null;}},showSingleLabel:function(xmlDoc)
{var lblinfo=xmlDoc.getElementsByTagName("lblinfo")[0].childNodes;var lbltitle=lblinfo[0].text;var lblx=lblinfo[1].text;var lbly=lblinfo[2].text;var lbllevel=lblinfo[3].text;document.getElementById("LABELTITLE").value=lbltitle;document.getElementById("LABELX").value=lblx;document.getElementById("LABELY").value=lbly;var ctX=parseFloat(lblx)*1e16;var ctY=parseFloat(lbly)*1e16;var ctPt=new Point(ctX,ctY);map.moveToCenter(ctPt,parseFloat(lbllevel));},addlabel:function()
{toolbar.clearCurrentToolStatus();toolbar.currentTool=null;document.getElementById("LABELS").value="";document.getElementById("DELETELABEL").disabled=true;document.getElementById("EDITLABEL").disabled=true;document.getElementById("LABELTITLE").readOnly=false;document.getElementById("LABELTITLE").value="";var mapDiv=toolbar.mapDiv;var mapModel=map.getMapModel();mapDiv.style.cursor="pointer";actionName="adding";Event.observe(mapDiv,"click",LabelPanel.prototype.dolabel.bindAsEventListener());},editlabel:function()
{toolbar.clearCurrentToolStatus();toolbar.currentTool=null;actionName="editing";document.getElementById("LABELTITLE").readOnly=false;document.getElementById("DELETELABEL").disabled=true;document.getElementById("PRESERVELABEL").disabled=false;var mapDiv=toolbar.mapDiv;var mapModel=map.getMapModel();mapDiv.style.cursor="pointer";Event.observe(mapDiv,"click",LabelPanel.prototype.dolabel.bindAsEventListener());},deletelabel:function()
{if(window.confirm("确定删除当前标签吗？"))
{var url="webgis.MapLabel.deleteById.d";var params="?labelid="+document.getElementById("LABELS").value;url=encodeURI(url);params=encodeURI(params);new Ajax.Request(url,{method:'post',parameters:params,onComplete:function(xmlHttp)
{var result=xmlHttp.responseText;if(result=="true")
{alert("标签删除成功！");document.getElementById("LABELTITLE").value="";document.getElementById("LABELX").value="";document.getElementById("LABELY").value="";document.getElementById("LABELLEVEL").value="";document.getElementById("EDITLABEL").disabled=true;document.getElementById("DELETELABEL").disabled=true;document.getElementById("PRESERVELABEL").disabled=true;LabelTool.prototype.getLabels();LabelPanel.prototype.getLabels();actionName="";}
else
{alert("标签删除失败！");}}});}},dolabel:function(e)
{if(currentLabel!=null&&currentLabel.length>0)
{var circleToDel=currentLabel[0];circleToDel.parentNode.removeChild(circleToDel);currentLabel=new Array();}
if((actionName=="adding"||actionName=="editing")&&toolbar.currentTool==null)
{var mapDiv=map.getVMLDiv();var mapModel=map.getMapModel();var currentPos=Util.getMouseRelativePixel(e,mapDiv);var center=Util.getCoordinateByPixel({x:currentPos.x,y:currentPos.y},mapModel.getZoom());document.getElementById("LABELX").value=center.x/1e16;document.getElementById("LABELY").value=center.y/1e16;document.getElementById("LABELLEVEL").value=mapModel.getZoom().getLevel();document.getElementById("PRESERVELABEL").disabled=false;var circleID="新标签";var tempcircle=new Circle(circleID,center.x+","+center.y,4,"red",1,"red");var tempcircle=tempcircle.setToMap(mapDiv,mapModel);tempcircle.title=tempcircle.id;currentLabel.push(tempcircle);currentLabel.push(circleID);currentLabel.push(center.x+","+center.y);setInterval(function()
{tempcircle.parentNode.removeChild(tempcircle);},4000);Event.stop(e);}}};